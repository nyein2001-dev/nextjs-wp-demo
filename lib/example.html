<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get all potential filter elements - using optional chaining to handle missing elements
    const addressSelect = document?.getElementById('selectTopic');
    const servicesSelect = document?.getElementById('selectTopic2');
    const categorySelect = document?.getElementById('selectTopic3');
    const hospitalNameInput = document?.getElementById('first-name');
    const searchForm = document?.getElementById('hospitalSearchForm');
    const resultsContainer = document?.getElementById('hospitalResults');

    // Function to safely get dropdown value
    function getDropdownValue(dropdown) {
        if (!dropdown) return null; // Return null if dropdown doesn't exist
        const value = dropdown.value;
        if (!value) return null; // Return null if no value selected
        return value.split('&&')[1] || ''; // Return actual value or empty string
    }

    // Function to check if element exists and has content
    function hasContent(element) {
        return element && element.textContent.trim() !== '';
    }

    // Function to filter hospitals
    function filterHospitals() {
        // Get filter values - only for elements that exist
        const filters = {
            address: addressSelect ? getDropdownValue(addressSelect) : null,
            service: servicesSelect ? getDropdownValue(servicesSelect) : null,
            category: categorySelect ? getDropdownValue(categorySelect) : null,
            name: hospitalNameInput ? hospitalNameInput.value.toLowerCase().trim() : null
        };

        // Get all hospital rows
        const hospitalRows = document.querySelectorAll('.hospital-row');

        hospitalRows.forEach(row => {
            // Get all possible data elements
            const elements = {
                name: row.querySelector('.hospital-name'),
                address: row.querySelector('.hospital-address'),
                services: row.querySelector('.hospital-services'),
                category: row.querySelector('.hospital-category')
            };

            // Check matches only for filters and elements that exist
            let shouldShow = true;

            // Check hospital name
            if (filters.name && hasContent(elements.name)) {
                shouldShow = shouldShow && elements.name.textContent.toLowerCase().includes(filters.name);
            }

            // Check address
            if (filters.address && hasContent(elements.address)) {
                shouldShow = shouldShow && elements.address.textContent.includes(filters.address);
            }

            // Check services
            if (filters.service && hasContent(elements.services)) {
                shouldShow = shouldShow && elements.services.textContent.includes(filters.service);
            }

            // Check category
            if (filters.category && hasContent(elements.category)) {
                shouldShow = shouldShow && elements.category.textContent.includes(filters.category);
            }

            // Show/hide row based on matches
            row.style.display = shouldShow ? '' : 'none';
        });

        // Handle no results
        showNoResultsMessage(hospitalRows);
    }

    // Function to show/hide no results message
    function showNoResultsMessage(hospitalRows) {
        const visibleRows = Array.from(hospitalRows).filter(row => row.style.display !== 'none');
        const noResultsElement = document.getElementById('noResults');

        if (visibleRows.length === 0) {
            if (!noResultsElement) {
                const noResults = document.createElement('div');
                noResults.id = 'noResults';
                noResults.className = 'row pd-100-60';
                noResults.innerHTML = '<div class="col-12 text-center">No hospitals found matching your criteria.</div>';
                resultsContainer?.appendChild(noResults);
            }
        } else if (noResultsElement) {
            noResultsElement.remove();
        }
    }

    // Add event listeners only for elements that exist
    if (searchForm) {
        searchForm.addEventListener('submit', function(e) {
            e.preventDefault();
            filterHospitals();
        });
    }

    // Function to reset filters
    function resetFilters() {
        // Reset only existing elements
        if (searchForm) searchForm.reset();
        if (addressSelect) addressSelect.selectedIndex = 0;
        if (servicesSelect) servicesSelect.selectedIndex = 0;
        if (categorySelect) categorySelect.selectedIndex = 0;
        if (hospitalNameInput) hospitalNameInput.value = '';

        // Show all rows
        const hospitalRows = document.querySelectorAll('.hospital-row');
        hospitalRows.forEach(row => row.style.display = '');

        // Remove no results message if it exists
        const noResults = document.getElementById('noResults');
        if (noResults) noResults.remove();
    }

    // Add reset button if search form exists
    if (searchForm) {
        const resetButton = document.createElement('button');
        resetButton.className = 'cta-secondary';
        resetButton.type = 'button'; // Prevent form submission
        resetButton.innerHTML = '<span>Reset</span>';
        resetButton.onclick = resetFilters;
        
        const submitButton = document.querySelector('.submit-form');
        if (submitButton?.parentNode) {
            submitButton.parentNode.appendChild(resetButton);
        }
    }
});
</script>
