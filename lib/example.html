<%@ page import="java.util.*" %>
<%@ page import="java.io.*" %>
<%@ page import="javax.xml.bind.DatatypeConverter" %>

<%!
// ===== Helper Functions for Encoding =====

/**
 * Converts a UUID string to byte array (16 bytes)
 */
private byte[] uuidToBytes(String uuid) {
    if (uuid == null) return null;
    
    String hex = uuid.replaceAll("-", "");
    if (hex.length() != 32) return null;
    
    byte[] bytes = new byte[16];
    try {
        for (int i = 0; i < 16; i++) {
            String hexPair = hex.substring(i * 2, i * 2 + 2);
            bytes[i] = (byte) Integer.parseInt(hexPair, 16);
        }
    } catch (NumberFormatException e) {
        return null;
    }
    
    return bytes;
}

/**
 * Base64 URL-safe encoding
 */
private String base64UrlEncode(byte[] bytes) {
    String base64 = DatatypeConverter.printBase64Binary(bytes);
    return base64.replace('+', '-')
                 .replace('/', '_')
                 .replaceAll("=+$", "");
}

/**
 * Encode payload with uniqueId, agentCode, and leadSource
 */
private String encodePayload(String uniqueId, String agentCode, String leadSource) throws Exception {
    byte[] uBytes = uuidToBytes(uniqueId);
    if (uBytes == null) {
        throw new Exception("uniqueId must be a valid UUID");
    }
    
    // Detect if agentCode is a UUID
    byte[] aBytes;
    boolean aIsUuid = false;
    byte[] maybeUuidBytes = uuidToBytes(agentCode);
    
    if (maybeUuidBytes != null) {
        aIsUuid = true;
        aBytes = maybeUuidBytes;
    } else {
        aBytes = agentCode.getBytes("UTF-8");
    }
    
    // Lead source as UTF-8 bytes
    byte[] lBytes = leadSource.getBytes("UTF-8");
    
    // Pack: uniqueId(16) + flag(1) + aLen(1) + agentCode + lLen(1) + leadSource
    int totalLength = 16 + 1 + 1 + aBytes.length + 1 + lBytes.length;
    byte[] result = new byte[totalLength];
    
    int pos = 0;
    
    // Copy uniqueId (16 bytes)
    System.arraycopy(uBytes, 0, result, pos, 16);
    pos += 16;
    
    // UUID flag (1 byte)
    result[pos++] = (byte)(aIsUuid ? 1 : 0);
    
    // Agent code length (1 byte)
    result[pos++] = (byte)aBytes.length;
    
    // Agent code bytes
    System.arraycopy(aBytes, 0, result, pos, aBytes.length);
    pos += aBytes.length;
    
    // Lead source length (1 byte)
    result[pos++] = (byte)lBytes.length;
    
    // Lead source bytes
    System.arraycopy(lBytes, 0, result, pos, lBytes.length);
    
    return base64UrlEncode(result);
}
%>

<%
// ===== Usage Example =====
try {
    // Configure your parameters here
    String uniqueId = "d5c03976-cc89-403b-973f-992d2c2b37bd";
    String agentCode = "12345678";
    String leadSource = "corpweb";
    
    // Encode the payload
    String token = encodePayload(uniqueId, agentCode, leadSource);
    
    // Output the token (you can modify this to store in session, database, etc.)
    out.print(token);
    
} catch (Exception e) {
    // Handle error as needed
    response.setStatus(HttpServletResponse.SC_INTERNAL_SERVER_ERROR);
    out.print("Error: " + e.getMessage());
}
%>

     133479830000

    <%
    String scheme = request.getScheme();          // http or https
    String serverName = request.getServerName();  // domain or IP
    int serverPort = request.getServerPort();     // port

    // Build base origin
    String origin = scheme + "://" + serverName;
    if ((scheme.equals("http") && serverPort != 80) ||
        (scheme.equals("https") && serverPort != 443)) {
        origin += ":" + serverPort;
    }

    // Special handling for intranet host
    if (("sgrasstvn4yt5w9.pru.intranet.asia".equals(serverName) && serverPort == 8443)) {
        origin += "/opencms";
    }

    out.println("Origin URL: " + origin);
%>

