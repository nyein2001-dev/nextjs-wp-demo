<%@ page import="java.io.*,java.util.*,java.text.*,java.nio.charset.*,
                 org.opencms.jsp.*,
                 org.opencms.main.*,org.opencms.file.*,
                 org.opencms.util.*,org.opencms.mail.*" %>
<%@ taglib prefix="cms" uri="http://www.opencms.org/taglib/cms" %>
<%
// Initialize the CMS action element for OpenCms operations
CmsJspActionElement cms = new CmsJspActionElement(pageContext, request, response);
CmsObject cmso = cms.getCmsObject();

// Configuration constants
final String CSV_FOLDER_PATH = "/system/modules/com.prudential.v2.ph/resources/csv-data/";
final String EMAIL_TEMPLATE_PATH = "/system/modules/com.prudential.v2.ph/resources/email-templates/daily-summary-template.html";
final String LOG_FOLDER_PATH = "/system/modules/com.prudential.v2.ph/resources/csv-logs/";
final String EOD_TIME = "17:30";

// Email configuration
final String EMAIL_FROM = "withdrawals@prulifeuk.com.ph";
final String[] EMAIL_RECIPIENTS_MORNING = {"morning-team@prulifeuk.com.ph"};
final String[] EMAIL_RECIPIENTS_EOD = {"eod-team@prulifeuk.com.ph", "management@prulifeuk.com.ph"};
final String EMAIL_SUBJECT_PREFIX = "Contact Info Updates - ";

// Get run type from request parameter
String runType = request.getParameter("runType");
boolean isMorningRun = "morning".equals(runType);

// Define a class with all the needed methods
class EmailDispatcher {
    private CmsObject cmso;
    private String logFolderPath;
    private String csvFolderPath;
    private String emailTemplatePath;
    private boolean isMorningRun;
    private String emailFrom;
    private String[] emailRecipientsMorning;
    private String[] emailRecipientsEod;
    private String emailSubjectPrefix;
    
    public EmailDispatcher(CmsObject cmso, String logFolderPath, String csvFolderPath, 
                           String emailTemplatePath, boolean isMorningRun, String emailFrom,
                           String[] emailRecipientsMorning, String[] emailRecipientsEod,
                           String emailSubjectPrefix) {
        this.cmso = cmso;
        this.logFolderPath = logFolderPath;
        this.csvFolderPath = csvFolderPath;
        this.emailTemplatePath = emailTemplatePath;
        this.isMorningRun = isMorningRun;
        this.emailFrom = emailFrom;
        this.emailRecipientsMorning = emailRecipientsMorning;
        this.emailRecipientsEod = emailRecipientsEod;
        this.emailSubjectPrefix = emailSubjectPrefix;
    }
    
    // Log function to write to OpenCms log file
    public void logMessage(String level, String message) {
        try {
            // Format the log entry with timestamp
            SimpleDateFormat timestampFormat = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss.SSS");
            String timestamp = timestampFormat.format(new Date());
            StringBuilder logEntry = new StringBuilder();
            logEntry.append(timestamp).append(" [").append(level).append("] ").append(message).append("\n");
            
            // Create log file path
            SimpleDateFormat logDateFormat = new SimpleDateFormat("yyyy-MM-dd");
            String date = logDateFormat.format(new Date());
            String logFilePath = logFolderPath + "email-dispatch-" + date + ".log";
            
            // Ensure log directory exists
            if (!cmso.existsResource(logFolderPath)) {
                // Create parent folders if they don't exist
                String[] pathSegments = logFolderPath.split("/");
                StringBuilder currentPath = new StringBuilder();
                
                for (String segment : pathSegments) {
                    if (segment.isEmpty()) continue;
                    
                    currentPath.append("/").append(segment);
                    String path = currentPath.toString();
                    
                    if (!cmso.existsResource(path)) {
                        cmso.createResource(path, 
                                          OpenCms.getResourceManager().getResourceType("folder").getTypeId(), 
                                          null, 
                                          new ArrayList<CmsProperty>());
                    }
                }
            }
            
            // Create or append to the log file
            if (!cmso.existsResource(logFilePath)) {
                // Create new log file
                byte[] content = logEntry.toString().getBytes(StandardCharsets.UTF_8);
                cmso.createResource(logFilePath, 
                                  OpenCms.getResourceManager().getResourceType("plain").getTypeId(), 
                                  content,
                                  new ArrayList<CmsProperty>());
            } else {
                // Read existing content
                CmsFile file = cmso.readFile(logFilePath);
                byte[] existingContent = file.getContents();
                String existingString = new String(existingContent, StandardCharsets.UTF_8);
                
                // Append new log entry
                String newContent = existingString + logEntry.toString();
                
                // Write updated content
                cmso.lockResource(logFilePath);
                file.setContents(newContent.getBytes(StandardCharsets.UTF_8));
                cmso.writeFile(file);
            }
        } catch (Exception e) {
            // Fall back to system logging if file logging fails
            System.out.println("Failed to write to log file: " + e.getMessage());
        }
    }

    // Clean up old log files
    public void cleanupOldLogFiles() {
        try {
            int LOG_RETENTION_DAYS = 7;
            Calendar cal = Calendar.getInstance();
            cal.add(Calendar.DAY_OF_MONTH, -LOG_RETENTION_DAYS);
            Date cutoffDate = cal.getTime();
            SimpleDateFormat dateFormat = new SimpleDateFormat("yyyy-MM-dd");
            
            // List all resources in the log directory
            List<CmsResource> resources = cmso.getResourcesInFolder(logFolderPath, CmsResourceFilter.ALL);
            
            for (CmsResource resource : resources) {
                String name = cmso.readPropertyObject(resource, CmsPropertyDefinition.PROPERTY_TITLE, false).getValue();
                if (name == null) {
                    name = resource.getName();
                }
                
                // Check if this is a log file matching our pattern
                if (name.startsWith("email-dispatch-") && name.endsWith(".log")) {
                    try {
                        // Extract date from the filename
                        String dateStr = name.substring(14, 24); // "email-dispatch-yyyy-MM-dd.log"
                        Date fileDate = dateFormat.parse(dateStr);
                        
                        // Delete if older than cutoff
                        if (fileDate.before(cutoffDate)) {
                            cmso.lockResource(resource.getRootPath());
                            cmso.deleteResource(resource.getRootPath(), CmsResource.DELETE_PRESERVE_SIBLINGS);
                            logMessage("INFO", "Deleted old log file: " + name);
                        }
                    } catch (Exception e) {
                        // Skip files that don't match our expected format
                        logMessage("WARN", "Could not parse date from log filename: " + name + ": " + e.getMessage());
                    }
                }
            }
        } catch (Exception e) {
            logMessage("ERROR", "Failed to clean up old log files: " + e.getMessage());
        }
    }

    // Read email template
    public String readEmailTemplate() throws Exception {
        try {
            CmsFile templateFile = cmso.readFile(emailTemplatePath);
            byte[] content = templateFile.getContents();
            return new String(content, StandardCharsets.UTF_8);
        } catch (Exception e) {
            logMessage("ERROR", "Failed to read email template from: " + emailTemplatePath + ": " + e.getMessage());
            throw e;
        }
    }

    // Generate email content
    public String generateEmailContent() throws Exception {
        try {
            // Read the email template
            logMessage("INFO", "Reading email template from: " + emailTemplatePath);
            String template = readEmailTemplate();
            
            // Get today's date
            SimpleDateFormat dateFormat = new SimpleDateFormat("MM-yyyy");
            String currentMonthYear = dateFormat.format(new Date());
            logMessage("INFO", "Generating email for period: " + currentMonthYear);
            
            // Replace date placeholder
            SimpleDateFormat fullDateFormat = new SimpleDateFormat("EEEE, MMMM d, yyyy");
            String todayDate = fullDateFormat.format(new Date());
            template = template.replace("${TODAY_DATE}", todayDate);
            
            // Replace run type placeholder
            String runTypeDisplay = isMorningRun ? "Morning (8:30 AM)" : "End of Day";
            template = template.replace("${RUN_TYPE}", runTypeDisplay);
            
            logMessage("INFO", "Email content generated successfully");
            return template;
        } catch (Exception e) {
            logMessage("ERROR", "Failed to generate email content: " + e.getMessage());
            throw e;
        }
    }

    // Attach CSV file to email
    public void attachMonthlyCsvFile(CmsHtmlMail email) throws Exception {
        // Get current month CSV filename with the specific format
        SimpleDateFormat dateFormat = new SimpleDateFormat("MM-yyyy");
        String currentMonthYear = dateFormat.format(new Date());
        String csvFileName = currentMonthYear + "-CWS-Leads.csv";
        String csvFilePath = csvFolderPath + csvFileName;

        logMessage("INFO", "Looking for CSV file: " + csvFilePath);

        // Check if the file exists
        if (!cmso.existsResource(csvFilePath)) {
            logMessage("WARN", "Monthly CSV file does not exist: " + csvFilePath);
            return; // Skip attachment if file doesn't exist
        }

        File tempFile = null;
        try {
            // Read the CSV file content
            logMessage("INFO", "Reading CSV file content");
            CmsFile csvFile = cmso.readFile(cmso.readResource(csvFilePath));
            byte[] fileContent = csvFile.getContents();
            logMessage("INFO", "CSV file size: " + fileContent.length + " bytes");
        
            // Create a temporary file that preserves the original filename
            tempFile = File.createTempFile(csvFileName.replace(".csv", "-"), ".csv");
            logMessage("INFO", "Created temporary file: " + tempFile.getAbsolutePath());
        
            try (FileOutputStream fos = new FileOutputStream(tempFile)) {
                fos.write(fileContent);
                logMessage("INFO", "Wrote CSV data to temporary file");
            }
        
            // Add the file as an attachment to the email with the original filename
            email.addAttachment(tempFile, csvFileName, "text/csv");
            logMessage("INFO", "Successfully attached monthly CSV file: " + csvFileName);
        
            // Schedule the temp file for deletion when JVM exits
            tempFile.deleteOnExit();
        } catch (Exception e) {
            logMessage("ERROR", "Failed to attach monthly CSV file: " + csvFilePath + ": " + e.getMessage());
        
            // Ensure temp file is cleaned up in case of failure
            if (tempFile != null && tempFile.exists()) {
                try {
                    tempFile.delete();
                    logMessage("INFO", "Cleaned up temporary file after error");
                } catch (Exception ex) {
                    logMessage("WARN", "Failed to clean up temporary file: " + tempFile.getAbsolutePath());
                }
            }
        
            throw e;
        }
    }

    // Send email
    public boolean sendEmail(String emailContent) {
        CmsHtmlMail email = null;
        
        try {
            email = new CmsHtmlMail();
            email.setCharset("UTF-8");
            email.setFrom(emailFrom);
            logMessage("INFO", "Setting email from: " + emailFrom);
            
            // Add recipients based on time of day
            String[] recipients = isMorningRun ? emailRecipientsMorning : emailRecipientsEod;
            for (String recipient : recipients) {
                email.addTo(recipient);
                logMessage("INFO", "Adding recipient: " + recipient);
            }
            
            // Set subject with current date
            SimpleDateFormat dateFormat = new SimpleDateFormat("yyyy-MM-dd");
            String today = dateFormat.format(new Date());
            String timeIndicator = isMorningRun ? "Morning Report" : "EOD Report";
            String subject = emailSubjectPrefix + timeIndicator + " (" + today + ")";
            email.setSubject(subject);
            logMessage("INFO", "Setting email subject: " + subject);
            
            // Set content
            email.setMsg(emailContent);
            logMessage("INFO", "Email content set, content length: " + emailContent.length() + " characters");

            // Attach CSV file
            logMessage("INFO", "Attempting to attach monthly CSV file");
            attachMonthlyCsvFile(email);
            
            // Send email
            logMessage("INFO", "Sending email");
            email.send();
            logMessage("INFO", "Email sent successfully");
            return true;
        } catch (Exception e) {
            logMessage("ERROR", "Failed to send email: " + e.getMessage());
            
            // Log specific email setup information for debugging
            if (email != null) {
                try {
                    logMessage("ERROR", "Email configuration at failure: " + 
                              "From: " + emailFrom + 
                              ", Recipients: " + Arrays.toString(isMorningRun ? 
                                                  emailRecipientsMorning : 
                                                  emailRecipientsEod));
                } catch (Exception ex) {
                    // Just continue if we can't log the email details
                }
            }
            
            return false;
        }
    }

    // Execute the email dispatch process
    public String execute() {
        String result = "Unknown";
        logMessage("INFO", "Starting automated email dispatch job with runType: " + (isMorningRun ? "morning" : "EOD"));

        try {
            // Clean up old log files
            cleanupOldLogFiles();
            
            // Generate email content
            logMessage("INFO", "Generating email content");
            String emailContent = generateEmailContent();
            
            // Send the email
            logMessage("INFO", "Sending email");
            boolean success = sendEmail(emailContent);
            
            if (success) {
                logMessage("INFO", "Email dispatch completed successfully");
                result = "Success: Email sent at " + new Date();
            } else {
                logMessage("ERROR", "Email dispatch failed");
                result = "Error: Email sending failed";
            }
        } catch (Exception e) {
            // Log error
            logMessage("ERROR", "Error in automated email dispatch job: " + e.getMessage());
            result = "Error: " + e.getMessage();
        }
        
        return result;
    }
}

// Create an instance of our EmailDispatcher class
EmailDispatcher dispatcher = new EmailDispatcher(
    cmso, 
    LOG_FOLDER_PATH, 
    CSV_FOLDER_PATH, 
    EMAIL_TEMPLATE_PATH,
    isMorningRun,
    EMAIL_FROM,
    EMAIL_RECIPIENTS_MORNING,
    EMAIL_RECIPIENTS_EOD,
    EMAIL_SUBJECT_PREFIX
);

// Execute the email dispatch process and get the result
String result = dispatcher.execute();
%>
<%= result %>
