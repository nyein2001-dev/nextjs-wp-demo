<%@ page session="false" contentType="text/html;charset=UTF-8" %>
<%@ page import="org.opencms.main.OpenCms" %>
<%@ page import="org.opencms.mail.CmsMailSettings" %>
<%@ page import="java.lang.reflect.Method" %>
<%@ page import="java.util.Properties" %>
<%@ taglib prefix="cms" uri="http://www.opencms.org/taglib/cms" %>
<html>
<head>
    <title>SMTP Settings Check - OpenCms 9.5.1</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { padding: 10px; margin: 10px 0; border: 1px solid #ccc; }
        .success { background-color: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; color: #856404; }
    </style>
</head>
<body>
    <h2>SMTP Configuration Check</h2>
    
    <div class="result info">
        <strong>OpenCms Version:</strong> <%= OpenCms.getSystemInfo().getVersionNumber() %><br>
        <strong>Java Version:</strong> <%= System.getProperty("java.version") %>
    </div>

    <%
    String smtpHost = "Not Found";
    String smtpPort = "Not Found";
    boolean configFound = false;
    %>

    <!-- Method 1: Try CmsMailSettings API -->
    <h3>Method 1: OpenCms Mail Settings API</h3>
    <%
    try {
        CmsMailSettings mailSettings = OpenCms.getSystemInfo().getMailSettings();
        if (mailSettings != null) {
            // Try to get mail host using reflection to handle API differences
            Method[] methods = mailSettings.getClass().getMethods();
            
            for (Method method : methods) {
                String methodName = method.getName();
                
                // Look for host-related methods
                if ((methodName.equals("getMailHost") || methodName.equals("getHost")) && 
                    method.getParameterCount() == 0) {
                    try {
                        Object hostResult = method.invoke(mailSettings);
                        if (hostResult != null && !hostResult.toString().trim().isEmpty()) {
                            smtpHost = hostResult.toString();
                            configFound = true;
                        }
                    } catch (Exception e) {
                        // Continue to next method
                    }
                }
                
                // Look for port-related methods
                if ((methodName.equals("getMailPort") || methodName.equals("getPort")) && 
                    method.getParameterCount() == 0) {
                    try {
                        Object portResult = method.invoke(mailSettings);
                        if (portResult != null) {
                            smtpPort = portResult.toString();
                            configFound = true;
                        }
                    } catch (Exception e) {
                        // Continue to next method
                    }
                }
            }
            
            if (configFound) {
    %>
    <div class="result success">
        <strong>SMTP Host:</strong> <%= smtpHost %><br>
        <strong>SMTP Port:</strong> <%= smtpPort %>
    </div>
    <%
            } else {
    %>
    <div class="result warning">
        Mail settings object exists but no host/port information found via API
    </div>
    <%
            }
        } else {
    %>
    <div class="result error">
        Mail settings object is null - mail may not be configured
    </div>
    <%
        }
    } catch (Exception e) {
    %>
    <div class="result error">
        Error accessing mail settings: <%= e.getMessage() %>
    </div>
    <%
    }
    %>

    <!-- Method 2: System Properties Check -->
    <h3>Method 2: System Properties</h3>
    <%
    try {
        Properties sysProps = System.getProperties();
        String sysPropHost = sysProps.getProperty("mail.smtp.host");
        String sysPropPort = sysProps.getProperty("mail.smtp.port");
        
        if (sysPropHost != null || sysPropPort != null) {
            if (sysPropHost != null && !configFound) {
                smtpHost = sysPropHost;
                configFound = true;
            }
            if (sysPropPort != null && smtpPort.equals("Not Found")) {
                smtpPort = sysPropPort;
                configFound = true;
            }
    %>
    <div class="result success">
        <strong>System Property - mail.smtp.host:</strong> <%= sysPropHost != null ? sysPropHost : "Not Set" %><br>
        <strong>System Property - mail.smtp.port:</strong> <%= sysPropPort != null ? sysPropPort : "Not Set" %>
    </div>
    <%
        } else {
    %>
    <div class="result info">
        No JavaMail system properties found
    </div>
    <%
        }
    } catch (Exception e) {
    %>
    <div class="result error">
        Error checking system properties: <%= e.getMessage() %>
    </div>
    <%
    }
    %>

    <!-- Method 3: JavaMail Session Default Properties -->
    <h3>Method 3: JavaMail Session Check</h3>
    <%
    try {
        Class.forName("javax.mail.Session");
        
        // Try to get default session properties
        Class sessionClass = Class.forName("javax.mail.Session");
        Method getDefaultInstanceMethod = sessionClass.getMethod("getDefaultInstance", Properties.class);
        
        Properties props = new Properties();
        Object session = getDefaultInstanceMethod.invoke(null, props);
        
        if (session != null) {
            Method getPropertiesMethod = session.getClass().getMethod("getProperties");
            Properties sessionProps = (Properties) getPropertiesMethod.invoke(session);
            
            String sessionHost = sessionProps.getProperty("mail.smtp.host");
            String sessionPort = sessionProps.getProperty("mail.smtp.port");
            
            if (sessionHost != null || sessionPort != null) {
    %>
    <div class="result info">
        <strong>JavaMail Session - Host:</strong> <%= sessionHost != null ? sessionHost : "Not Set" %><br>
        <strong>JavaMail Session - Port:</strong> <%= sessionPort != null ? sessionPort : "Not Set" %>
    </div>
    <%
            } else {
    %>
    <div class="result info">
        JavaMail Session available but no SMTP properties set
    </div>
    <%
            }
        }
    } catch (ClassNotFoundException e) {
    %>
    <div class="result warning">
        JavaMail API not available - may need mail.jar for Java 6
    </div>
    <%
    } catch (Exception e) {
    %>
    <div class="result info">
        JavaMail available but no default session properties found
    </div>
    <%
    }
    %>

    <!-- Final Results Summary -->
    <h3>Summary</h3>
    <%
    if (configFound) {
    %>
    <div class="result success">
        <strong>✓ SMTP Configuration Found:</strong><br>
        <strong>Host:</strong> <%= smtpHost %><br>
        <strong>Port:</strong> <%= smtpPort %>
    </div>
    <%
    } else {
    %>
    <div class="result error">
        <strong>✗ No SMTP Configuration Found</strong><br>
        SMTP may not be configured in OpenCms or configuration is not accessible via API.
        <br><br>
        <strong>Next Steps:</strong><br>
        1. Check if mail configuration exists in WEB-INF/config/opencms-system.xml<br>
        2. Verify the &lt;mail&gt; section contains &lt;mailhost&gt; and &lt;mailport&gt; elements<br>
        3. Restart OpenCms after configuration changes
    </div>
    <%
    }
    %>

    <!-- Configuration File Location -->
    <h3>Configuration File Information</h3>
    <%
    try {
        String configPath = OpenCms.getSystemInfo().getConfigurationFileRfsPath();
    %>
    <div class="result info">
        <strong>Configuration Directory:</strong> <%= configPath %><br>
        <strong>System Config File:</strong> <%= configPath %>/opencms-system.xml<br>
        <strong>Look for:</strong> &lt;mail&gt; section with &lt;mailhost&gt; and &lt;mailport&gt; elements
    </div>
    <%
    } catch (Exception e) {
    %>
    <div class="result info">
        Default configuration location: WEB-INF/config/opencms-system.xml
    </div>
    <%
    }
    %>

</body>
</html>
