/**
 * Form Management System
 * Handles dynamic form behavior, validation, and submission
 */

class FormManager {
    constructor() {
        this.elements = this.initializeElements();
        this.state = {
            lastCheckedRadio: null,
            isSubmitting: false
        };
        this.config = {
            maxFileSize: 5 * 1024 * 1024, // 5MB
            maxTotalSize: 20 * 1024 * 1024, // 20MB
            allowedFileTypes: ['.png', '.jpeg', '.pdf', '.doc', '.docx', '.heic', '.jpg']
        };
        
        this.init();
    }

    initializeElements() {
        return {
            select: document.getElementById('select-service'),
            sectionInputForm: document.getElementById('section-input-form'),
            formBottomSection: document.getElementById('form-bottom-section'),
            allViews: document.querySelectorAll('.dropdown-view'),
            unavailableText: document.getElementById('unavailable-text'),
            radios: document.querySelectorAll('input[type="radio"]'),
            transitionOption: document.getElementById('product-title'),
            form: document.querySelector('.dynamic-form-submission'),
            emailInput: document.getElementById('email-address'),
            policyInput: document.getElementById('policy-number'),
            clickHereLink: document.getElementById('clickHereLink')
        };
    }

    init() {
        this.initDropdownHandler();
        this.initRadioHandler();
        this.initFormSubmission();
        this.initSimpleSubmission();
        this.initBootstrapSelect();
    }

    // Dropdown Management
    initDropdownHandler() {
        if (!this.elements.select) return;
        
        this.showSelectedView();
        this.elements.select.addEventListener('change', () => this.showSelectedView());
    }

    showSelectedView() {
        const selectedOption = this.elements.select.options[this.elements.select.selectedIndex];
        const selectedId = selectedOption?.getAttribute('data.option-id');
        
        console.log('Selected Option:', selectedOption, 'ID:', selectedId);

        this.resetViews();

        if (!selectedId) {
            console.log('No value selected');
            return;
        }

        const isAvailable = selectedOption.getAttribute('data-available') === 'true';
        const isIncludeRadio = selectedOption.getAttribute('data-include-radio') === 'true';
        const unavailableText = selectedOption.getAttribute('data-unavailable-text') || 'This option is unavailable.';

        if (isAvailable) {
            this.showAvailableOption(selectedId, isIncludeRadio);
        } else {
            this.showUnavailableOption(unavailableText);
        }
    }

    resetViews() {
        this.elements.allViews.forEach(view => view.style.display = 'none');
        this.elements.unavailableText.style.display = 'none';
        this.elements.unavailableText.textContent = '';
        this.elements.transitionOption.value = '';
        
        this.elements.radios.forEach(radio => {
            if (radio.name !== "policyRadios") {
                radio.checked = false;
            }
        });
        
        this.resetFileRequirements();
    }

    showAvailableOption(selectedId, isIncludeRadio) {
        const selectedView = document.getElementById(selectedId);
        
        if (selectedView) {
            selectedView.style.display = 'block';
            this.setFileRequirements(selectedView);
            console.log('Showing view for:', selectedId);
        }

        this.toggleFormSections(!isIncludeRadio);
    }

    showUnavailableOption(text) {
        this.toggleFormSections(false);
        this.elements.unavailableText.innerHTML = text;
        this.elements.unavailableText.style.display = 'block';
        console.log('Showing unavailable text:', text);
    }

    toggleFormSections(show) {
        const display = show ? 'block' : 'none';
        this.elements.sectionInputForm.style.display = display;
        this.elements.formBottomSection.style.display = display;
    }

    // Radio Button Management
    initRadioHandler() {
        this.elements.radios.forEach(radio => {
            radio.addEventListener('change', () => this.handleRadioChange(radio));
        });
    }

    handleRadioChange(radio) {
        this.hidePreviousRadioView();
        this.showCurrentRadioView(radio);
        this.state.lastCheckedRadio = radio;
    }

    hidePreviousRadioView() {
        if (!this.state.lastCheckedRadio) return;

        const prevDropdownId = this.state.lastCheckedRadio.getAttribute('data-dropdown-id') || '';
        const prevSelectedId = `${prevDropdownId}_${this.state.lastCheckedRadio.id}`;
        const prevView = document.getElementById(prevSelectedId);

        if (prevView) {
            prevView.style.display = 'none';
            this.resetFileRequirements(prevView);
            console.log('Hiding view for:', prevSelectedId);
        }
    }

    showCurrentRadioView(radio) {
        const radioId = radio.id;
        const radioValue = radio.value;
        const dropdownId = radio.getAttribute('data-dropdown-id') || '';
        const selectedId = `${dropdownId}_${radioId}`;

        console.log("Radio ID:", radioId, "Value:", radioValue, "Selected ID:", selectedId);

        const selectedView = document.getElementById(selectedId);
        if (selectedView) {
            this.elements.select.value = "";
            this.elements.transitionOption.value = radioValue;
            selectedView.style.display = 'block';
            this.setFileRequirements(selectedView);
            this.toggleFormSections(true);
            console.log('Showing view for:', selectedId);
        }
    }

    // File Management
    resetFileRequirements(container = document) {
        container.querySelectorAll('.dropdown-view input[type="file"]').forEach(fileInput => {
            fileInput.removeAttribute('required');
        });
    }

    setFileRequirements(container) {
        container.querySelectorAll('.dropdown-view input[type="file"]').forEach(fileInput => {
            const isRequired = fileInput.getAttribute('data-is-required') === 'true';
            if (isRequired) {
                fileInput.setAttribute('required', 'required');
            }
        });
    }

    // Form Validation
    validateBasicFields() {
        const email = this.elements.emailInput?.value.trim() || '';
        const policyNumber = this.elements.policyInput?.value.trim() || '';

        if (!email || !policyNumber) {
            this.showNotification('All fields marked with * are mandatory', true);
            return false;
        }

        if (!/^\d{8}$/.test(policyNumber)) {
            this.showNotification('Invalid Policy Number.', true);
            return false;
        }

        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
            this.showNotification('Please enter a valid email address.', true);
            return false;
        }

        return true;
    }

    validateFiles() {
        const fileInputs = this.elements.form?.querySelectorAll('input[type="file"]') || [];
        let totalSize = 0;

        for (const input of fileInputs) {
            const validation = this.validateSingleFileInput(input);
            if (!validation.isValid) {
                this.showNotification(validation.message, true);
                return false;
            }
            totalSize += validation.size;
        }

        if (totalSize > this.config.maxTotalSize) {
            const totalSizeMB = (totalSize / (1024 * 1024)).toFixed(2);
            this.showNotification(`Total file size exceeds the maximum of 20MB. Current total: ${totalSizeMB}MB.`, true);
            return false;
        }

        return true;
    }

    validateSingleFileInput(input) {
        const isRequired = input.hasAttribute('required');
        const files = input.files;
        let totalSize = 0;

        if (isRequired && (!files || files.length === 0)) {
            return {
                isValid: false,
                message: "Mandatory document required. Please upload to proceed.",
                size: 0
            };
        }

        if (files && files.length > 0) {
            for (const file of files) {
                const fileSizeMB = file.size / (1024 * 1024);
                totalSize += file.size;

                if (fileSizeMB > 5) {
                    return {
                        isValid: false,
                        message: "The uploaded file exceeds the maximum allowed size of 5 MB. Please upload a file that is 5 MB or smaller to proceed.",
                        size: totalSize
                    };
                }

                if (!this.isValidFileType(file.name)) {
                    return {
                        isValid: false,
                        message: "The uploaded file type is not supported. Please upload a file in acceptable formats to proceed",
                        size: totalSize
                    };
                }
            }
        }

        return { isValid: true, message: '', size: totalSize };
    }

    isValidFileType(fileName) {
        const lowerFileName = fileName.toLowerCase();
        return this.config.allowedFileTypes.some(type => 
            lowerFileName.endsWith(type.toLowerCase())
        );
    }

    verifyRecaptcha() {
        const recaptchaElement = this.elements.form?.querySelector('.g-recaptcha[data-recaptcha]');
        if (!recaptchaElement) return true;

        const recaptchaResponse = window.grecaptcha?.getResponse();
        if (!recaptchaResponse || recaptchaResponse.length === 0) {
            this.showNotification('Please complete the reCAPTCHA verification.', true);
            return false;
        }

        return true;
    }

    // Form Submission
    initFormSubmission() {
        if (!this.elements.form) return;

        this.elements.form.setAttribute('enctype', 'multipart/form-data');
        this.elements.form.addEventListener('submit', (event) => this.handleFormSubmit(event));
        this.setupFormObserver();
        this.overrideAjaxIfExists();
    }

    handleFormSubmit(event) {
        event.preventDefault();
        
        if (this.state.isSubmitting) return;

        this.hideNotification();

        if (!this.validateBasicFields() || !this.verifyRecaptcha() || !this.validateFiles()) {
            return;
        }

        this.submitForm();
    }

    async submitForm() {
        const submitUrl = this.elements.form.getAttribute('data-url-submit');
        const redirectUrl = this.elements.form.getAttribute('data-url-redirect');

        if (!submitUrl) return;

        try {
            this.state.isSubmitting = true;
            this.showProgress();

            const formData = new FormData(this.elements.form);
            const response = await this.makeRequest('POST', submitUrl, formData);

            this.handleFormResponse(response, redirectUrl);
        } catch (error) {
            this.showNotification('An error occurred while submitting the form. Please try again.', true);
        } finally {
            this.state.isSubmitting = false;
            this.hideProgress();
        }
    }

    handleFormResponse(response, redirectUrl) {
        if (response.statusCode === 200) {
            if (redirectUrl) {
                window.location.href = redirectUrl;
            } else {
                this.showNotification('Form submitted successfully!', false);
            }
        } else {
            this.showNotification(response.message || 'An error occurred during form submission.', true);
        }
    }

    // Simple Submission (Click Here Link)
    initSimpleSubmission() {
        if (!this.elements.clickHereLink) return;

        this.elements.clickHereLink.addEventListener('click', (event) => {
            event.preventDefault();
            this.handleSimpleSubmission();
        });
    }

    async handleSimpleSubmission() {
        this.hideNotification();

        if (!this.validateBasicFields()) return;

        try {
            this.showProgress();
            
            const formData = this.createSimpleFormData();
            const response = await this.makeRequest('POST', '../action/simple-contact-form.jsp', formData);
            
            this.handleSimpleResponse(response);
        } catch (error) {
            this.showNotification('Network error. Please check your connection and try again.', true);
        } finally {
            this.hideProgress();
        }
    }

    createSimpleFormData() {
        const formData = new FormData();
        formData.append('policy-number', this.elements.policyInput.value.trim());
        formData.append('email-address', this.elements.emailInput.value.trim());

        // Add optional fields
        const formSourceInput = document.getElementById('form-source-name');
        if (formSourceInput?.value) {
            formData.append('form-source-name', formSourceInput.value);
        }

        const filePathInput = document.querySelector('input[name="file-path"]');
        if (filePathInput?.value) {
            formData.append('file-path', filePathInput.value);
        }

        return formData;
    }

    handleSimpleResponse(response) {
        if (response.statusCode === 200) {
            this.showNotification('Your request has been submitted successfully!', false);
            this.clearBasicFields();
            
            // Auto-hide success message
            setTimeout(() => this.hideNotification(), 5000);
        } else {
            this.showNotification(response.message || 'An error occurred during submission.', true);
        }
    }

    clearBasicFields() {
        if (this.elements.policyInput) this.elements.policyInput.value = '';
        if (this.elements.emailInput) this.elements.emailInput.value = '';
    }

    // HTTP Request Helper
    makeRequest(method, url, data) {
        return new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            
            xhr.addEventListener('load', () => {
                if (xhr.status >= 200 && xhr.status < 300) {
                    try {
                        const response = JSON.parse(xhr.responseText.trim());
                        resolve(response);
                    } catch (e) {
                        reject(new Error('Invalid JSON response'));
                    }
                } else {
                    reject(new Error(`Server error: ${xhr.status} ${xhr.statusText}`));
                }
            });
            
            xhr.addEventListener('error', () => reject(new Error('Network error')));
            xhr.addEventListener('abort', () => reject(new Error('Request aborted')));
            
            xhr.open(method, url, true);
            xhr.send(data);
        });
    }

    // UI Helpers
    showProgress() {
        const progressContainer = this.getOrCreateProgressElement();
        progressContainer.classList.remove('--hide');
    }

    hideProgress() {
        const progressContainer = document.querySelector('.loader');
        if (progressContainer) {
            progressContainer.classList.add('--hide');
        }
    }

    showNotification(message, isError = true) {
        const notiElement = this.getOrCreateNotificationElement();
        const messageElement = notiElement.querySelector('[data-noti-message]');
        const titleElement = notiElement.querySelector('.notification-form__title');

        if (messageElement) messageElement.textContent = message;
        if (titleElement) titleElement.textContent = isError ? 'Error' : 'Success';

        notiElement.classList.remove('d-none');
        notiElement.classList.toggle('error', isError);
        notiElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    hideNotification() {
        const notiElement = document.querySelector('[data-noti]');
        if (notiElement) {
            notiElement.classList.add('d-none');
        }
    }

    getOrCreateProgressElement() {
        let element = document.querySelector('.loader');
        if (!element && this.elements.form) {
            element = document.createElement('div');
            element.className = 'loader --hide';
            element.innerHTML = this.getProgressHTML();
            this.elements.form.parentNode.appendChild(element);
        }
        return element;
    }

    getOrCreateNotificationElement() {
        let element = document.querySelector('[data-noti]');
        if (!element && this.elements.form) {
            element = document.createElement('div');
            element.className = 'notification-form d-none';
            element.setAttribute('data-noti', '');
            element.innerHTML = this.getNotificationHTML();
            this.elements.form.insertBefore(element, this.elements.form.firstChild);
        }
        return element;
    }

    getProgressHTML() {
        const items = Array.from({ length: 12 }, (_, i) => 
            `<div class="loader-item${i > 0 ? ` loader-item-${i + 1}` : ''}"></div>`
        ).join('');
        
        return `
            <div class="loader-wrapper">
                <div class="loader-wrapper-item">
                    ${items}
                </div>
            </div>
        `;
    }

    getNotificationHTML() {
        return `
            <span class="icon icon-warning-triangle notification-form__icon"></span>
            <div class="notification-form__content">
                <div class="notification-form__title">Error</div>
                <div class="notification-form__desc" data-noti-message></div>
            </div>
        `;
    }

    // Setup Helpers
    setupFormObserver() {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'attributes' && 
                    mutation.attributeName === 'enctype' && 
                    this.elements.form.getAttribute('enctype') !== 'multipart/form-data') {
                    this.elements.form.setAttribute('enctype', 'multipart/form-data');
                }
            });
        });
        observer.observe(this.elements.form, { attributes: true });
    }

    overrideAjaxIfExists() {
        if (!window.$ || !window.$.ajax) return;

        const submitUrl = this.elements.form.getAttribute('data-url-submit');
        const originalAjaxSubmit = window.$.ajax;
        
        window.$.ajax = (options) => {
            if (options?.url === submitUrl && options.data instanceof FormData) {
                if (!this.verifyRecaptcha() || !this.validateFiles()) {
                    if (options.error && typeof options.error === 'function') {
                        options.error(null, 'error', 'Validation failed');
                    }
                    return {
                        abort: () => {},
                        fail: function() { return this; },
                        always: function() { return this; }
                    };
                }
            }
            return originalAjaxSubmit.apply(this, arguments);
        };
    }

    initBootstrapSelect() {
        if (window.$) {
            window.$('select').on('shown.bs.select', function() {
                window.$('.dropdown-menu').css({
                    'max-width': 'none !important',
                    'width': 'auto !important'
                });
            });
        }
    }
}

// Initialize the form manager when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    new FormManager();
});
