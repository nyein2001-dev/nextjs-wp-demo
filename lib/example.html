function handleFileInput(fileInputId) {
    const fileInput = document.getElementById(fileInputId);
    const fileList = document.getElementById(`fileList-${fileInputId}`);
    const removeAllButton = document.getElementById(`removeAllButton-${fileInputId}`);
    const errorElement = document.getElementById(`error-${fileInputId}`);
    let accumulatedFiles = []; // Array to store accumulated files

    fileInput.addEventListener('change', () => {
        errorElement.style.display = 'none';
        let currentFiles = Array.from(fileInput.files);
        let validFiles = [];
        let sizeExceeded = false;

        // Check individual file size and for duplicate files
        currentFiles.forEach(file => {
            if (file.size > MAX_FILE_SIZE) {
                sizeExceeded = true;
                errorElement.textContent = `File "${file.name}" exceeds 5MB and was not added.`;
                errorElement.style.display = 'block';
            } else if (accumulatedFiles.some(f => f.name === file.name && f.size === file.size)) {
                errorElement.textContent = `File "${file.name}" is already uploaded and was not added again.`;
                errorElement.style.display = 'block';
            } else {
                validFiles.push(file);
            }
        });

        let newTotalSize = totalFileSize + validFiles.reduce((sum, file) => sum + file.size, 0);
        if (newTotalSize > MAX_TOTAL_SIZE) {
            document.getElementById('totalSizeWarning').style.display = 'block';
            return;
        } else {
            document.getElementById('totalSizeWarning').style.display = 'none';
        }

        totalFileSize = newTotalSize;

        // Append new valid files to accumulated files
        accumulatedFiles.push(...validFiles);

        fileList.innerHTML = ''; // Clear file list for fresh render
        removeAllButton.classList.remove('hidden');

        accumulatedFiles.forEach((file, index) => {
            const fileLabel = document.createElement('div');
            fileLabel.className = 'file-label';

            if (file.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                fileLabel.appendChild(img);
            }

            const fileInfo = document.createElement('div');
            fileInfo.className = 'file-info';
            fileInfo.innerHTML = `<span>${file.name}</span><small>${(file.size / 1024).toFixed(2)} KB</small>`;
            fileLabel.appendChild(fileInfo);

            const removeButton = document.createElement('button');
            removeButton.className = 'remove-button';
            removeButton.textContent = 'Remove';
            removeButton.onclick = () => {
                fileLabel.remove();
                totalFileSize -= file.size;
                accumulatedFiles.splice(index, 1); // Remove file from accumulated files
                if (fileList.children.length === 0) {
                    removeAllButton.classList.add('hidden');
                    fileInput.value = '';
                }
            };
            fileLabel.appendChild(removeButton);

            fileList.appendChild(fileLabel);
        });

        // Clear the input to allow selecting the same file again
        fileInput.value = '';
    });

    removeAllButton.addEventListener('click', () => {
        // Clear accumulated files and reset UI
        accumulatedFiles = [];
        totalFileSize = 0;
        fileList.innerHTML = '';
        fileInput.value = '';
        removeAllButton.classList.add('hidden');
    });
}
