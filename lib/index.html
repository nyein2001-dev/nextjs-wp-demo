<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Enhanced File Attachments</title>
</head>
<body>

<div class="agreement-form_label">${item.value.Instructions}</div>

<c:if test="${fn:length(item.valueList.Attachment) > 0}">
    <c:if test="${item.value.AttachmentNotice.isSet}">
        <br>
        <h2 class="agreement-form_label">Attachment:</h2>
        <div class="agreement-form_label">${item.value.AttachmentNotice}</div>
    </c:if>
</c:if>

<c:if test="${fn:length(item.valueList.Attachment) > 0}">
    <c:choose>
        <c:when test="${item.value.dynamicfiles == 'true'}">
            <!-- Dynamic Files Version -->
            <div id="dynamic-files-container">
                <c:forEach var="attachment" items="${item.valueList.Attachment}" varStatus="status">
                    <div class="file-attachment-item" id="file-item-${status.index}" style="${status.index == 0 ? 'display: block;' : 'display: none;'}">
                        <h2 class="group-field_title" ${attachment.value.IsRequired == 'true' ? 'data-required' : ''}>${attachment.value.Description}</h2>
                        <fieldset class="section-radio-checkbox" data-radio-checkbox-popup="">
                            <legend class="sr-only">${attachment.value.Description}</legend>
                            <div class="radio-checkbox_wrapper field-item">
                                <div class="radio-checkbox" style="${status.index > 0 ? 'position: relative;' : ''}">
                                    <c:set var="isCheckRequireATopic" value=""></c:set>
                                    <c:if test="${attachment.value.AttachementValidation.value.Title == 'Mandatory'}">
                                        <c:set var="isCheckRequireATopic" value="required data-parsley-required-message='${attachment.value.AttachementValidation.value.ErrorMessageMandatoryField}'"></c:set>
                                    </c:if>
                                    <input class="field-input" ${status.index == 0 ? isCheckRequireATopic : ''} type="file" 
                                           name="${attachment.value.Description}" 
                                           placeholder="${attachment.value.Description}" 
                                           data-is-required="${attachment.value.IsRequired}" 
                                           data-parsley-trigger="keyup input" 
                                           accept="${attachment.value.AcceptFileType}"
                                           onchange="handleFileChange(${status.index})"
                                           data-file-index="${status.index}">
                                    <c:if test="${status.index > 0}">
                                        <button type="button" class="remove-file-btn" onclick="removeFileItem(${status.index})" 
                                                style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: #ff4444; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 14px; line-height: 1;">Ã—</button>
                                    </c:if>
                                </div>
                            </div>
                        </fieldset>
                    </div>
                </c:forEach>
                
                <!-- Add Document Button (hidden by default) -->
                <button type="button" id="add-document-btn" onclick="addNextDocument()" 
                        style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-top: 10px; display: none;">
                    Add Next Document
                </button>
                
                <!-- Max Files Message -->
                <div id="max-files-message" style="display: none; color: #666; font-style: italic; margin-top: 10px;">
                    You have reached the maximum number of documents allowed.
                </div>
            </div>
            
            <script>
                var totalFiles = ${fn:length(item.valueList.Attachment)}; // Total number of files from forEach
                
                function addNextDocument() {
                    // Find the first hidden file item to show
                    for (var i = 1; i < totalFiles; i++) {
                        var item = document.getElementById('file-item-' + i);
                        if (item && item.style.display === 'none') {
                            item.style.display = 'block';
                            break;
                        }
                    }
                    
                    // Check if all files are now visible
                    var visibleCount = 0;
                    for (var i = 0; i < totalFiles; i++) {
                        var item = document.getElementById('file-item-' + i);
                        if (item && item.style.display !== 'none') {
                            visibleCount++;
                        }
                    }
                    
                    // If all files are visible, hide add button and show max message
                    if (visibleCount >= totalFiles) {
                        document.getElementById('add-document-btn').style.display = 'none';
                        document.getElementById('max-files-message').style.display = 'block';
                    }
                }
                
                function removeFileItem(index) {
                    if (index === 0) return; // First item cannot be removed
                    
                    var fileItem = document.getElementById('file-item-' + index);
                    var fileInput = fileItem.querySelector('input[type="file"]');
                    
                    // Clear the file input
                    fileInput.value = '';
                    
                    // Hide the file item
                    fileItem.style.display = 'none';
                    
                    // Check if we have any hidden files to potentially show
                    var hasHiddenFiles = false;
                    for (var i = 1; i < totalFiles; i++) {
                        var item = document.getElementById('file-item-' + i);
                        if (item && item.style.display === 'none') {
                            hasHiddenFiles = true;
                            break;
                        }
                    }
                    
                    // Show add button and hide max message if there are hidden files
                    if (hasHiddenFiles) {
                        document.getElementById('add-document-btn').style.display = 'inline-block';
                        document.getElementById('max-files-message').style.display = 'none';
                    }
                }
                // Initialize
                document.addEventListener('DOMContentLoaded', function() {
                    // Ensure only the first file item is visible initially
                    for (var i = 1; i < totalFiles; i++) {
                        var item = document.getElementById('file-item-' + i);
                        if (item) {
                            item.style.display = 'none';
                        }
                    }
                    
                    // Hide add button if there's only one file
                    if (totalFiles <= 1) {
                        document.getElementById('add-document-btn').style.display = 'none';
                    }
                });
            </script>
        </c:when>
        
        <c:otherwise>
            <!-- Original Static Files Version (unchanged when dynamicfiles is false) -->
            <c:forEach var="attachment" items="${item.valueList.Attachment}">
                <h2 class="group-field_title" ${attachment.value.IsRequired == 'true' ? 'data-required' : ''}>${attachment.value.Description}</h2>
                <fieldset class="section-radio-checkbox" data-radio-checkbox-popup="">
                    <legend class="sr-only">${attachment.value.Description}</legend>
                    <div class="radio-checkbox_wrapper field-item">
                        <div class="radio-checkbox">
                            <c:set var="isCheckRequireATopic" value=""></c:set>
                            <c:if test="${attachment.value.AttachementValidation.value.Title == 'Mandatory'}">
                                <c:set var="isCheckRequireATopic" value="required data-parsley-required-message='${attachment.value.AttachementValidation.value.ErrorMessageMandatoryField}'"></c:set>
                            </c:if>
                            <input class="field-input" ${isCheckRequireATopic} type="file" 
                                   name="${attachment.value.Description}" 
                                   placeholder="${attachment.value.Description}" 
                                   data-is-required="${attachment.value.IsRequired}" 
                                   data-parsley-trigger="keyup input" 
                                   accept="${attachment.value.AcceptFileType}">
                        </div>
                    </div>
                </fieldset>
            </c:forEach>
        </c:otherwise>
    </c:choose>
</c:if>

</body>
</html>
