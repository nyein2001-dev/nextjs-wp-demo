<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ page import="java.net.*" %>
<%@ page import="java.io.*" %>
<%@ page import="java.util.*" %>
<%@ page import="org.json.simple.*" %>
<%@ page import="org.json.simple.parser.*" %>

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>OpenCms Authentication Integration</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .btn {
            background-color: #007cba;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .btn:hover {
            background-color: #005a87;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }
        .token-info {
            background-color: #e7f3ff;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 4px solid #007cba;
        }
        .token-label {
            font-weight: bold;
            color: #333;
        }
        .token-value {
            font-family: monospace;
            background-color: #f8f9fa;
            padding: 5px;
            border-radius: 3px;
            margin-top: 5px;
            word-break: break-all;
        }
        .loading {
            display: none;
            color: #007cba;
            font-style: italic;
        }
    </style>
    <script>
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('submitBtn').disabled = true;
        }
    </script>
</head>
<body>
    <div class="container">
        <h1>OpenCms API Authentication</h1>
        <p>Compatible with OpenCms 9.5.1 and Java &lt; 7</p>
        
        <%
        String username = request.getParameter("username");
        String password = request.getParameter("password");
        String message = "";
        String messageType = "";
        String accessToken = "";
        String expiresIn = "";
        
        // Helper method to check if string is valid
        boolean isValidString(String str) {
            return str != null && !str.trim().isEmpty();
        }
        
        if (isValidString(username) && isValidString(password)) {
            HttpURLConnection connection = null;
            BufferedReader reader = null;
            OutputStreamWriter writer = null;
            
            try {
                // Create the API endpoint URL
                String baseUrl = request.getScheme() + "://" + request.getServerName();
                if (request.getServerPort() != 80 && request.getServerPort() != 443) {
                    baseUrl += ":" + request.getServerPort();
                }
                URL url = new URL(baseUrl + "/auth/login");
                
                // Open connection
                connection = (HttpURLConnection) url.openConnection();
                
                // Set connection properties for Java < 7 compatibility
                connection.setRequestMethod("POST");
                connection.setRequestProperty("Content-Type", "application/json; charset=UTF-8");
                connection.setRequestProperty("Accept", "application/json");
                connection.setRequestProperty("User-Agent", "OpenCms-Auth-Client/1.0");
                connection.setDoOutput(true);
                connection.setDoInput(true);
                connection.setUseCaches(false);
                
                // Set timeout values (in milliseconds)
                connection.setConnectTimeout(10000); // 10 seconds connection timeout
                connection.setReadTimeout(15000);    // 15 seconds read timeout
                
                // Create JSON request body using json-simple
                JSONObject jsonRequest = new JSONObject();
                jsonRequest.put("username", username.trim());
                jsonRequest.put("password", password);
                String jsonInputString = jsonRequest.toJSONString();
                
                // Send POST request
                writer = new OutputStreamWriter(connection.getOutputStream(), "UTF-8");
                writer.write(jsonInputString);
                writer.flush();
                
                // Get response code
                int responseCode = connection.getResponseCode();
                
                if (responseCode == 200) {
                    // Read successful response
                    reader = new BufferedReader(new InputStreamReader(connection.getInputStream(), "UTF-8"));
                    StringBuffer response = new StringBuffer();
                    String line;
                    
                    while ((line = reader.readLine()) != null) {
                        response.append(line);
                    }
                    
                    // Parse JSON response using json-simple
                    JSONParser parser = new JSONParser();
                    JSONObject jsonResponse = (JSONObject) parser.parse(response.toString());
                    
                    // Extract token information
                    Object accessTokenObj = jsonResponse.get("accessToken");
                    Object expiresInObj = jsonResponse.get("expiresIn");
                    
                    accessToken = accessTokenObj != null ? accessTokenObj.toString() : "";
                    expiresIn = expiresInObj != null ? expiresInObj.toString() : "N/A";
                    
                    if (isValidString(accessToken)) {
                        message = "Authentication successful!";
                        messageType = "success";
                        
                        // Store in session for later use
                        session.setAttribute("accessToken", accessToken);
                        session.setAttribute("expiresIn", expiresIn);
                        session.setAttribute("username", username);
                        session.setAttribute("loginTime", new java.util.Date().toString());
                    } else {
                        message = "Authentication failed: No access token received from server.";
                        messageType = "error";
                    }
                    
                } else {
                    // Handle error responses
                    BufferedReader errorReader = null;
                    String errorMessage = "HTTP " + responseCode;
                    
                    try {
                        if (connection.getErrorStream() != null) {
                            errorReader = new BufferedReader(new InputStreamReader(connection.getErrorStream(), "UTF-8"));
                            StringBuffer errorResponse = new StringBuffer();
                            String errorLine;
                            
                            while ((errorLine = errorReader.readLine()) != null) {
                                errorResponse.append(errorLine);
                            }
                            
                            if (errorResponse.length() > 0) {
                                // Try to parse error response as JSON
                                try {
                                    JSONParser errorParser = new JSONParser();
                                    JSONObject errorJson = (JSONObject) errorParser.parse(errorResponse.toString());
                                    Object errorMsg = errorJson.get("message");
                                    if (errorMsg != null) {
                                        errorMessage += ": " + errorMsg.toString();
                                    } else {
                                        errorMessage += ": " + errorResponse.toString();
                                    }
                                } catch (Exception parseEx) {
                                    errorMessage += ": " + errorResponse.toString();
                                }
                            } else {
                                errorMessage += ": " + connection.getResponseMessage();
                            }
                        } else {
                            errorMessage += ": " + connection.getResponseMessage();
                        }
                        
                    } catch (Exception e) {
                        errorMessage += ": " + connection.getResponseMessage();
                    } finally {
                        if (errorReader != null) {
                            try { errorReader.close(); } catch (IOException e) { /* ignore */ }
                        }
                    }
                    
                    message = "Authentication failed. " + errorMessage;
                    messageType = "error";
                }
                
            } catch (SocketTimeoutException e) {
                message = "Connection timeout: The server took too long to respond. Please try again.";
                messageType = "error";
            } catch (ConnectException e) {
                message = "Connection failed: Unable to connect to the authentication server. Please check if the server is running and accessible.";
                messageType = "error";
            } catch (UnknownHostException e) {
                message = "Connection failed: Unable to resolve server hostname. Please check your network connection.";
                messageType = "error";
            } catch (MalformedURLException e) {
                message = "Configuration error: Invalid API endpoint URL.";
                messageType = "error";
            } catch (org.json.simple.parser.ParseException e) {
                message = "Response parsing error: Invalid JSON response from server. The server may be experiencing issues.";
                messageType = "error";
            } catch (IOException e) {
                message = "Network error: " + e.getMessage() + ". Please check your connection and try again.";
                messageType = "error";
            } catch (Exception e) {
                message = "Unexpected error: " + e.getMessage() + ". Please contact system administrator if the problem persists.";
                messageType = "error";
            } finally {
                // Clean up resources - important for Java < 7
                if (writer != null) {
                    try { writer.close(); } catch (Exception e) { /* ignore */ }
                }
                if (reader != null) {
                    try { reader.close(); } catch (IOException e) { /* ignore */ }
                }
                if (connection != null) {
                    try { connection.disconnect(); } catch (Exception e) { /* ignore */ }
                }
            }
        }
        %>
        
        <!-- Display messages -->
        <% if (!message.isEmpty()) { %>
            <div class="<%= messageType %>">
                <%= message %>
            </div>
        <% } %>
        
        <!-- Display token information on success -->
        <% if ("success".equals(messageType) && !accessToken.isEmpty()) { %>
            <div class="token-info">
                <div class="token-label">Access Token:</div>
                <div class="token-value"><%= accessToken %></div>
            </div>
            <div class="token-info">
                <div class="token-label">Expires In:</div>
                <div class="token-value"><%= expiresIn %> seconds</div>
            </div>
            <div class="token-info">
                <div class="token-label">Login Time:</div>
                <div class="token-value"><%= session.getAttribute("loginTime") %></div>
            </div>
        <% } %>
        
        <!-- Login Form -->
        <form method="post" action="auth-login.jsp" onsubmit="showLoading()">
            <div class="form-group">
                <label for="username">Username:</label>
                <input type="text" id="username" name="username" 
                       value="<%= username != null ? username : "" %>" 
                       required maxlength="100">
            </div>
            
            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" name="password" 
                       required maxlength="100">
            </div>
            
            <button type="submit" id="submitBtn" class="btn">Authenticate</button>
            <div id="loading" class="loading">Processing authentication...</div>
        </form>
        
        <!-- Session Information -->
        <% if (session.getAttribute("accessToken") != null) { %>
            <div style="margin-top: 30px; padding: 15px; background-color: #f8f9fa; border-radius: 4px;">
                <h4>Current Session:</h4>
                <p><strong>User:</strong> <%= session.getAttribute("username") %></p>
                <p><strong>Login Time:</strong> <%= session.getAttribute("loginTime") %></p>
                <p><strong>Token Status:</strong> Active</p>
                <a href="auth-logout.jsp" style="color: #dc3545; text-decoration: none;">Logout</a>
            </div>
        <% } %>
        
        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; font-size: 12px; color: #666;">
            <strong>Technical Details:</strong><br>
            • API Endpoint: /auth/login<br>
            • Method: POST<br>
            • Content-Type: application/json<br>
            • Connection Timeout: 10 seconds<br>
            • Read Timeout: 15 seconds<br>
            • Compatible with: OpenCms 9.5.1, Java &lt; 7<br>
            • JSON Library: json-simple 1.1.1
        </div>
    </div>
</body>
</html>
