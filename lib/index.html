public static File createTempFileFromInputStream(InputStream inputStream, String prefix, String suffix) throws IOException {
    File tempFile = File.createTempFile(prefix, suffix);
    FileOutputStream out = null;
    try {
        out = new FileOutputStream(tempFile);
        byte[] buffer = new byte[1024];
        int bytesRead;
        while ((bytesRead = inputStream.read(buffer)) != -1) {
            out.write(buffer, 0, bytesRead);
        }
    } finally {
        if (out != null) {
            try {
                out.close();
            } catch (IOException e) {
                // log or ignore
            }
        }
        if (inputStream != null) {
            try {
                inputStream.close();
            } catch (IOException e) {
                // log or ignore
            }
        }
    }
    return tempFile;
}


public static void sendEmail(String from, String to, String subject, String message, Map<String, List<FileItem>> fieldFilesMap) throws Exception {
    CmsHtmlMail email = new CmsHtmlMail();
    email.setFrom(from);
    email.addTo(to);
    email.setSubject(subject);
    email.setMsg(message);
    email.setCharset("UTF-8");

    Iterator<Map.Entry<String, List<FileItem>>> iterator = fieldFilesMap.entrySet().iterator();
    while (iterator.hasNext()) {
        Map.Entry<String, List<FileItem>> entry = iterator.next();
        String fieldName = entry.getKey();
        List<FileItem> fileItems = entry.getValue();

        for (int i = 0; i < fileItems.size(); i++) {
            FileItem fileItem = (FileItem) fileItems.get(i);
            String originalFileName = fileItem.getName();
            String extension = "";
            int dotIndex = originalFileName.lastIndexOf('.');
            if (dotIndex > 0) {
                extension = originalFileName.substring(dotIndex);
            }

            String renamedFile = fieldName + "_" + i + extension;
            File tempFile = createTempFileFromInputStream(fileItem.getInputStream(), fieldName + "_" + i, extension);

            EmailAttachment attachment = new EmailAttachment();
            attachment.setPath(tempFile.getAbsolutePath());
            attachment.setName(renamedFile);
            attachment.setDisposition(EmailAttachment.ATTACHMENT);
            email.attach(attachment);

            tempFile.deleteOnExit();
        }
    }

    email.send();
}


            // Send to user
if (!StringUtils.isEmpty(emailAddressUser)) {
    sendEmail(
        (String) emailAddressAdmins.get(0),
        emailAddressUser,
        mailSubject,
        mailContentUser,
        fieldFilesMap
    );
}

// Send to admins
for (int i = 0; i < emailAddressAdmins.size(); i++) {
    String adminEmail = (String) emailAddressAdmins.get(i);
    sendEmail(
        emailAddressUser,
        adminEmail,
        adminMailSubject,
        mailContent,
        fieldFilesMap
    );
}
