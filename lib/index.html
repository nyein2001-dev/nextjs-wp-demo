<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<%@ page import="java.io.*" %>
<%@ page import="java.net.*" %>
<%@ page import="java.util.*" %>
<%@ page import="javax.servlet.http.*" %>

<%!
    // Helper method to read response from InputStream
    private String readResponse(InputStream inputStream) throws IOException {
        BufferedReader reader = new BufferedReader(new InputStreamReader(inputStream, "UTF-8"));
        StringBuilder response = new StringBuilder();
        String line;
        while ((line = reader.readLine()) != null) {
            response.append(line);
        }
        reader.close();
        return response.toString();
    }
    
    // Simple JSON parser for extracting values (compatible with pre-Java 7)
    private String extractJsonValue(String json, String key) {
        try {
            String searchKey = "\"" + key + "\"";
            int keyIndex = json.indexOf(searchKey);
            if (keyIndex == -1) return null;
            
            int colonIndex = json.indexOf(":", keyIndex);
            if (colonIndex == -1) return null;
            
            int valueStart = colonIndex + 1;
            while (valueStart < json.length() && 
                   (json.charAt(valueStart) == ' ' || json.charAt(valueStart) == '\t')) {
                valueStart++;
            }
            
            if (valueStart >= json.length()) return null;
            
            char firstChar = json.charAt(valueStart);
            int valueEnd;
            
            if (firstChar == '"') {
                // String value
                valueStart++; // Skip opening quote
                valueEnd = json.indexOf('"', valueStart);
                if (valueEnd == -1) return null;
                return json.substring(valueStart, valueEnd);
            } else {
                // Number value
                valueEnd = valueStart;
                while (valueEnd < json.length() && 
                       Character.isDigit(json.charAt(valueEnd))) {
                    valueEnd++;
                }
                if (valueEnd == valueStart) return null;
                return json.substring(valueStart, valueEnd);
            }
        } catch (Exception e) {
            return null;
        }
    }
    
    // Method to perform authentication API call
    private Map<String, String> authenticateUser(String username, String password, String apiBaseUrl) {
        Map<String, String> result = new HashMap<String, String>();
        HttpURLConnection connection = null;
        
        try {
            // Construct the full API URL
            String apiUrl = apiBaseUrl + "/auth/login";
            URL url = new URL(apiUrl);
            
            // Create HTTP connection
            connection = (HttpURLConnection) url.openConnection();
            connection.setRequestMethod("POST");
            connection.setRequestProperty("Content-Type", "application/json");
            connection.setRequestProperty("Accept", "application/json");
            connection.setDoOutput(true);
            connection.setDoInput(true);
            
            // Set timeout values (in milliseconds)
            connection.setConnectTimeout(10000); // 10 seconds
            connection.setReadTimeout(15000);    // 15 seconds
            
            // Prepare JSON request body
            String jsonPayload = "{\"username\":\"" + username + "\",\"password\":\"" + password + "\"}";
            
            // Send request
            OutputStream outputStream = connection.getOutputStream();
            OutputStreamWriter writer = new OutputStreamWriter(outputStream, "UTF-8");
            writer.write(jsonPayload);
            writer.flush();
            writer.close();
            outputStream.close();
            
            // Get response code
            int responseCode = connection.getResponseCode();
            result.put("responseCode", String.valueOf(responseCode));
            
            if (responseCode == 200) {
                // Success - read response
                InputStream inputStream = connection.getInputStream();
                String response = readResponse(inputStream);
                inputStream.close();
                
                result.put("success", "true");
                result.put("response", response);
                
                // Extract accessToken and expiresIn from JSON response
                String accessToken = extractJsonValue(response, "accessToken");
                String expiresIn = extractJsonValue(response, "expiresIn");
                
                if (accessToken != null) {
                    result.put("accessToken", accessToken);
                }
                if (expiresIn != null) {
                    result.put("expiresIn", expiresIn);
                }
                
            } else {
                // Error response
                result.put("success", "false");
                try {
                    InputStream errorStream = connection.getErrorStream();
                    if (errorStream != null) {
                        String errorResponse = readResponse(errorStream);
                        errorStream.close();
                        result.put("errorResponse", errorResponse);
                    }
                } catch (Exception e) {
                    result.put("errorResponse", "Unable to read error response");
                }
            }
            
        } catch (SocketTimeoutException e) {
            result.put("success", "false");
            result.put("error", "Connection timeout occurred");
            result.put("errorDetails", e.getMessage());
        } catch (ConnectException e) {
            result.put("success", "false");
            result.put("error", "Unable to connect to the authentication server");
            result.put("errorDetails", e.getMessage());
        } catch (UnknownHostException e) {
            result.put("success", "false");
            result.put("error", "Authentication server not found");
            result.put("errorDetails", e.getMessage());
        } catch (IOException e) {
            result.put("success", "false");
            result.put("error", "IO error occurred during authentication");
            result.put("errorDetails", e.getMessage());
        } catch (Exception e) {
            result.put("success", "false");
            result.put("error", "Unexpected error occurred");
            result.put("errorDetails", e.getMessage());
        } finally {
            if (connection != null) {
                connection.disconnect();
            }
        }
        
        return result;
    }
%>

<%
    // Initialize variables
    String username = "";
    String password = "";
    String apiBaseUrl = "";
    Map<String, String> authResult = null;
    boolean showResult = false;
    
    // Check if form was submitted
    if ("POST".equalsIgnoreCase(request.getMethod())) {
        username = request.getParameter("username");
        password = request.getParameter("password");
        apiBaseUrl = request.getParameter("apiBaseUrl");
        
        // Validate input
        if (username != null && !username.trim().isEmpty() && 
            password != null && !password.trim().isEmpty() &&
            apiBaseUrl != null && !apiBaseUrl.trim().isEmpty()) {
            
            // Perform authentication
            authResult = authenticateUser(username.trim(), password.trim(), apiBaseUrl.trim());
            showResult = true;
        }
    }
%>

<!DOCTYPE html>
<html>
<head>
    <title>OpenCms Authentication API Integration</title>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input[type="text"], input[type="password"], input[type="url"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
        }
        .submit-btn {
            background-color: #007cba;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        .submit-btn:hover {
            background-color: #005a8b;
        }
        .result-container {
            margin-top: 30px;
            padding: 20px;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .token-info {
            background-color: #e7f3ff;
            border: 1px solid #b8daff;
            color: #004085;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
        }
        .token-value {
            font-family: monospace;
            background-color: #f8f9fa;
            padding: 5px;
            border-radius: 3px;
            word-break: break-all;
        }
        .note {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>OpenCms Authentication API Integration</h1>
        
        <div class="note">
            <strong>Note:</strong> This integration is designed for OpenCms 9.5.1 and Java versions prior to Java 7. 
            Enter your API credentials below to test the authentication endpoint.
        </div>
        
        <form method="post" action="">
            <div class="form-group">
                <label for="apiBaseUrl">API Base URL:</label>
                <input type="url" 
                       id="apiBaseUrl" 
                       name="apiBaseUrl" 
                       value="<%= apiBaseUrl %>" 
                       placeholder="https://your-api-server.com"
                       required>
            </div>
            
            <div class="form-group">
                <label for="username">Username:</label>
                <input type="text" 
                       id="username" 
                       name="username" 
                       value="<%= username %>" 
                       placeholder="Enter your username"
                       required>
            </div>
            
            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" 
                       id="password" 
                       name="password" 
                       placeholder="Enter your password"
                       required>
            </div>
            
            <button type="submit" class="submit-btn">Authenticate</button>
        </form>
        
        <% if (showResult && authResult != null) { %>
            <div class="result-container <%= "true".equals(authResult.get("success")) ? "success" : "error" %>">
                <% if ("true".equals(authResult.get("success"))) { %>
                    <h3>✓ Authentication Successful!</h3>
                    <p><strong>Response Code:</strong> <%= authResult.get("responseCode") %></p>
                    
                    <% if (authResult.get("accessToken") != null || authResult.get("expiresIn") != null) { %>
                        <div class="token-info">
                            <h4>Authentication Details:</h4>
                            
                            <% if (authResult.get("accessToken") != null) { %>
                                <p><strong>Access Token:</strong></p>
                                <div class="token-value"><%= authResult.get("accessToken") %></div>
                            <% } %>
                            
                            <% if (authResult.get("expiresIn") != null) { %>
                                <p><strong>Expires In:</strong> <%= authResult.get("expiresIn") %> seconds</p>
                            <% } %>
                        </div>
                    <% } %>
                    
                    <% if (authResult.get("response") != null) { %>
                        <details style="margin-top: 15px;">
                            <summary style="cursor: pointer; font-weight: bold;">Raw Response</summary>
                            <pre style="background-color: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto;"><%= authResult.get("response") %></pre>
                        </details>
                    <% } %>
                    
                <% } else { %>
                    <h3>✗ Authentication Failed</h3>
                    
                    <% if (authResult.get("responseCode") != null) { %>
                        <p><strong>Response Code:</strong> <%= authResult.get("responseCode") %></p>
                    <% } %>
                    
                    <% if (authResult.get("error") != null) { %>
                        <p><strong>Error:</strong> <%= authResult.get("error") %></p>
                    <% } %>
                    
                    <% if (authResult.get("errorDetails") != null) { %>
                        <p><strong>Details:</strong> <%= authResult.get("errorDetails") %></p>
                    <% } %>
                    
                    <% if (authResult.get("errorResponse") != null) { %>
                        <details style="margin-top: 15px;">
                            <summary style="cursor: pointer; font-weight: bold;">Server Error Response</summary>
                            <pre style="background-color: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto;"><%= authResult.get("errorResponse") %></pre>
                        </details>
                    <% } %>
                <% } %>
            </div>
        <% } %>
    </div>
</body>
</html>
