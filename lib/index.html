<%@ page session="false" contentType="text/html;charset=UTF-8" %>
<%@ page import="java.io.*, java.net.*, javax.net.*,  org.json.JSONObject,
org.opencms.main.OpenCms, org.apache.commons.logging.Log, org.opencms.main.CmsLog, org.apache.commons.lang.StringUtils,
java.util.*, org.opencms.jsp.util.*, java.io.IOException, java.text.*, java.nio.charset.* "%>
<%@ page import="org.opencms.mail.CmsHtmlMail"%>
<%@page import="java.util.Locale" %>
<%@ page import="javax.servlet.http.Cookie" %>
<%@page import="org.opencms.jsp.CmsJspActionElement"%>
<%@ taglib prefix="cms" uri="http://www.opencms.org/taglib/cms"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>
<%@page import="javax.xml.bind.DatatypeConverter"%>
<%@page import="org.opencms.jsp.*, org.opencms.file.*, org.opencms.flex.*,org.opencms.util.*, java.util.*" %>
<c:set var="locale" value="${cms.locale}" />
<fmt:setLocale value="${param.language}" />
<%
//paramSelectTopic
String paramSelectTopic = StringUtils.isEmpty(request.getParameter("selectTopic")) ? "" : request.getParameter("selectTopic");
String[] paramSelectTopics = paramSelectTopic.split("&&");
%>

<cms:bundle basename="com.prudential.v2.ph.default">
  <c:set var="productTitle"><fmt:message key="key.default.have.productTitle" /></c:set>
  <c:set var="noProductTitle"><fmt:message key="key.default.none.productTitle" /></c:set>
  <c:set var="adminMailSubject"><fmt:message key="key.default.admin.mail.subject" /></c:set>
  <c:set var="paramSelectTopics"><%=paramSelectTopics[0]%></c:set>
  <c:set var="emailEnquiry" value=""/>
  <c:if test="${not empty paramSelectTopics}">
  	<c:set var="emailEnquiry"><fmt:message key="key.mail.selected.enquiry.${paramSelectTopics}" /></c:set>
  </c:if>
</cms:bundle>
<%!
	public String A1filter(String input){
	    String tem = input;
	    tem = tem.replaceAll("<", "&lt;");
	    tem = tem.replaceAll(">", "&gt;");
	    tem = tem.replaceAll("&", "&amp;");
	    tem = tem.replaceAll("\"", "&quot;");
	    tem = tem.replaceAll(" ", "&nbsp;");
	    tem = tem.replaceAll("'", "&#39;");
	    return tem;
	}
    public String A1filterHidden(String input,String temp){
	    String tem = temp;
	    String tmpinput = "content:'" + input + "'; mso-hide:all;display:none;";
	    tem = tem.replaceAll(tmpinput, "");
	    return tem;
    }
    public  String A1filter(String input,String value,String temp){
        String tem = temp;
        tem = tem.replaceAll(input, value);
        return tem;
    }
    public String A1filterNoProductTitle(String productTitleName,String temp,String noProductTitle){
        String tem = temp;
        tem = tem.replaceAll(productTitleName, noProductTitle);
        return tem;
    }
     public String responeObject(int statusCode,String message) {
        StringBuilder sb = new StringBuilder();
        sb.append("{");
        sb.append("\"statusCode\":").append(statusCode).append(",");
        sb.append("\"message\":\"").append(message).append("\"");
        sb.append("}");
        return sb.toString();
    }
%>
<%
        CmsJspActionElement cms = new CmsJspActionElement(pageContext, request, response);
        CmsObject cmsObject = cms.getCmsObject();
        Locale locale = cms.getRequestContext().getLocale(); 
        String productTitleParam = pageContext.getAttribute("productTitle").toString();
        String noProductTitleParam = pageContext.getAttribute("noProductTitle").toString();
        // get file xml content
        String pathFile = request.getParameter("file-path");
        byte[] valueDecoded = DatatypeConverter.parseBase64Binary(pathFile);
        String pathFileXml = new String(valueDecoded, "UTF-8");
        CmsResource contentRs = cmsObject.readResource(pathFileXml);
        CmsJspContentAccessBean componentPros = new CmsJspContentAccessBean(cmsObject, locale, contentRs);
        // get option send mail 
        String SendEmail = componentPros.getValue().get("EmailAndDB").getValue().get("SendEmail").getStringValue();
        Boolean isSendEmail = Boolean.valueOf(SendEmail);
		
        String SendEmailBasedonTopic = componentPros.getValue().get("EmailAndDB").getValue().get("SendEmailBasedonTopic").getStringValue();
        Boolean isSendEmailBasedonTopic = Boolean.valueOf(SendEmailBasedonTopic);
		
		
        // get content tempalate mail admin
        String templateContentAdmin = componentPros.getValue().get("EmailAndDB").getValue().get("EmailContentAdmins").getStringValue();
        CmsResource resource = cmsObject.readResource(templateContentAdmin);
        CmsFile file = cmsObject.readFile(resource);
        byte[] contentAdmin = file.getContents();

        String mailContent = new String(contentAdmin);	
		
        // get content tempalate mail user
        String templateContentUser = componentPros.getValue().get("EmailAndDB").getValue().get("EmailContentEndUser").getStringValue();
        CmsResource resourceUser = cmsObject.readResource(templateContentUser);
        CmsFile fileUser = cmsObject.readFile(resourceUser);
        byte[] contentUser = fileUser.getContents();
        String mailContentUser = new String(contentUser);
        // mail admin in dialog
        String emailAddressAdmin = componentPros.getValue().get("EmailAndDB").getValue().get("EmailAddress").getStringValue();
       // mail user in xml file
        String emailAddressUser  =  "";
        // mail subject
        String topic = StringUtils.isEmpty(paramSelectTopic) ? "" : paramSelectTopics[1];
        String topickey = StringUtils.isEmpty(paramSelectTopic) ? "" : paramSelectTopics[0];
        String adminMailSubject = pageContext.getAttribute("adminMailSubject").toString();
        adminMailSubject = adminMailSubject.replace("#Topic#", topic);
        String mailSubject = componentPros.getValue().get("EmailAndDB").getValue().get("EmailSubject").getStringValue();
        mailSubject = mailSubject.replace("#Topic#", topic);
		
        String adminMailSubject2 = componentPros.getValue().get("EmailAndDB").getValue().get("AdminEmailSubject").getStringValue();
		if(!StringUtils.isEmpty(adminMailSubject2))
		{		
        	adminMailSubject2 = adminMailSubject2.replace("#Topic#", topic);
			adminMailSubject = adminMailSubject2;
		}
		
		
        // messge send mail fails
        String errMesageSendMailFails = componentPros.getValue().get("GeneralForm").getValue().get("GenericErrorMessage").getStringValue();
        // Section Title 1
        String section1 = componentPros.getValue().get("Section1").getValue().get("SectionTitle").getStringValue();
        if(!StringUtils.isEmpty(section1)){
            String temp = "%class" + "Section1" + "%";
            mailContent = A1filterHidden(temp, mailContent);
            mailContentUser = A1filterHidden(temp, mailContentUser);
        }
       // Section Label 2
        String section2 = componentPros.getValue().get("Section2").getValue().get("SectionLabel").getStringValue();
        if(!StringUtils.isEmpty(section2)){
            String temp = "%class" + "Section2" + "%";
            mailContent = A1filterHidden(temp, mailContent);
            mailContentUser = A1filterHidden(temp, mailContentUser);
        }
        // Section Label 3
        String section3 = componentPros.getValue().get("Section3").getValue().get("SectionLabel").getStringValue();
        if(!StringUtils.isEmpty(section3)){
            String temp = "%class" + "Section3" + "%";
            mailContent = A1filterHidden(temp, mailContent);
            mailContentUser = A1filterHidden(temp, mailContentUser);
        }
        // Section Label 5
        String section5 = componentPros.getValue().get("Section5").getValue().get("SectionLabel").getStringValue();
        if(!StringUtils.isEmpty(section5)){
            String temp = "%class" + "Section5" + "%";
            mailContent = A1filterHidden(temp, mailContent);
            mailContentUser = A1filterHidden(temp, mailContentUser);
        } 

        if(!isSendEmail){
             out.print(responeObject(200,"send mail success"));
             return;
        }

        Enumeration<?> enumeration = request.getParameterNames();
        String firstName = "";
        String lastName = "";
        String maritalStatus = "";
        String componentCode = "";
        String policy_number = "";
        String provide_area = "";
        String country_code = "";
        String phone_no = "";
        String utmCampaign = "";
        String utmMedium = "";
        String utmSource = "";
		String nationalId = "";
        String accessToken = "";
        boolean isEmailSuccess = false;
        boolean isApiCallSuccess = true;
        String apiResponse = "";

        try{

            while(enumeration.hasMoreElements()){
                String parameterName = enumeration.nextElement().toString();
                String value = "";
                if(parameterName.equals("selectTopic")){
                    value = topic;
                }else{
                    value = A1filter(request.getParameter(parameterName));
                }
                if(!StringUtils.isEmpty(value)) {
                    String temp = "%class" + parameterName + "%";
                    mailContent = A1filterHidden(temp, mailContent);
                    mailContentUser = A1filterHidden(temp, mailContentUser);
                    mailContent = A1filter("%" + parameterName + "%", value, mailContent);
                    mailContentUser = A1filter("%" + parameterName + "%", value, mailContentUser);
                }
                // get first name
                if("first-name".equals(parameterName)){
                    firstName = value;
                }
                // get last name
                if("last-name".equals(parameterName)){
                    lastName = value;
                }
                // mail user in form
                if("email-address".equals(parameterName)) {
                    emailAddressUser = value;
                }
                if("policy-number".equals(parameterName)){
                    policy_number = value;
                }
                if("provide-area".equals(parameterName)){
                    provide_area = value;
                }
                if("country-code".equals(parameterName)){
                    country_code = value;
                }
                if("phone-no".equals(parameterName)){
                    phone_no = value;
                }
                 if("id-passport-number".equals(parameterName)){
                    nationalId = value;
                }
				
                if("maritalStatus".equals(parameterName)){
                    maritalStatus = value;
                }
				
                if("current-url".equals(parameterName)){
                    componentCode = value;
                }				
				
                if("utmCampaign".equals(parameterName)){
                    utmCampaign = value;
                }
                
                if("utmMedium".equals(parameterName)){
                    utmMedium = value;
                }
                
                if("utmSource".equals(parameterName)){
                    utmSource = value;
                }
                // product title
                if("product-title".equals(parameterName)) {
                    String nameTitle = "%key-" + parameterName + "%";
                    if(StringUtils.isEmpty(value)) {
                        mailContent =  A1filterNoProductTitle(nameTitle,mailContent,noProductTitleParam);
                        mailContentUser =  A1filterNoProductTitle(nameTitle,mailContentUser,noProductTitleParam);
                    } else {
                        String productTitle = productTitleParam + " " + value;
                        mailContent = A1filter(nameTitle,productTitle,mailContent);
                        mailContentUser = A1filter(nameTitle,productTitle,mailContentUser);
                    }
                }
            }
            
            
            if(StringUtils.isEmpty(policy_number)) {
                mailContent = mailContent.replace("%policy-number%", "-");
                mailContentUser = mailContentUser.replace("%policy-number%", "-");
            }
            
            // get full name
            String fullName = firstName + " " + lastName;
            if(!StringUtils.isEmpty(fullName.trim())){
                String temp = "%class" + "fullName" + "%";
                mailContent = A1filterHidden(temp, mailContent);
                mailContentUser = A1filterHidden(temp, mailContentUser);
                mailContent = A1filter("%" + "fullName" + "%", fullName, mailContent);
                mailContentUser = A1filter("%" + "fullName" + "%", fullName, mailContentUser);
            }
            
            List<String> emailAddressAdmins = new ArrayList<String>();
            if(isSendEmailBasedonTopic){
                		
                String emailEnquiry = componentPros.getValue().get("EmailAndDB").getValue().get("EmailAddress"+topickey).getStringValue();
        
                if(!StringUtils.isEmpty(emailEnquiry) && !StringUtils.isEmpty(paramSelectTopic)){
                        emailAddressAdmins = Arrays.asList(emailEnquiry.split(","));
                }else{
                    emailAddressAdmins = Arrays.asList(emailAddressAdmin.split(","));
                }
            } else {
                String emailEnquiry = pageContext.getAttribute("emailEnquiry").toString();
                
                if(!StringUtils.isEmpty(emailEnquiry) && !StringUtils.isEmpty(paramSelectTopic)){
                    emailAddressAdmins = Arrays.asList(emailEnquiry.split(","));
                }else{
                    emailAddressAdmins = Arrays.asList(emailAddressAdmin.split(","));
                }
            }
    
        
            // send mail to user
            /*if(!StringUtils.isEmpty(emailAddressUser) && !StringUtils.isEmpty(mailSubject)){
                CmsHtmlMail smToCs = new CmsHtmlMail();
                smToCs.setMsg(mailContentUser);
                smToCs.setSubject(mailSubject);
                smToCs.setCharset("UTF-8");
                smToCs.setFrom(emailAddressAdmins.get(0));
                smToCs.addTo(emailAddressUser);
                smToCs.send();
            }
            // send mails to admin
            for (String emailAdmin : emailAddressAdmins) {
                CmsHtmlMail smToCsAdmin = new CmsHtmlMail();
                smToCsAdmin.setMsg(mailContent);
                smToCsAdmin.setSubject(adminMailSubject);
                smToCsAdmin.setCharset("UTF-8");
                smToCsAdmin.setFrom(emailAddressUser);
                smToCsAdmin.addTo(emailAdmin);
                smToCsAdmin.send(); 
            }*/
            isEmailSuccess = true; 
        }catch(Exception e){
            out.print(e.toString());
            out.print(responeObject(500,errMesageSendMailFails));  
        }
        

        if(!isEmailSuccess){
            return;
        } 
        
        String responseMessage = "";

        try{

            //get access token
            URL url = new URL("https://pru-api-nprd.prudential.com.vn/pruforce/lead-corporate/uat1/auth/login"); 
            HttpURLConnection con = (HttpURLConnection) url.openConnection(); 
            con.setRequestProperty("Content-Type", "application/json");
            con.setRequestProperty("accept", "application/json");
            con.setRequestMethod("POST"); 
            con.setDoOutput(true);
            con.setConnectTimeout(5000);
            con.setReadTimeout(5000);
            
            JSONObject jsonObject = new JSONObject();
            jsonObject.put("password", "Prudential01@");
            jsonObject.put("username", "pulseleaduat");

            byte[] bout = jsonObject.toString().getBytes(StandardCharsets.UTF_8);
            int length = bout.length;

            con.setFixedLengthStreamingMode(length);
            con.connect();
            
            OutputStream os = con.getOutputStream();
            os.write(bout);

            
            StringBuffer content = new StringBuffer();           
            BufferedReader in = new BufferedReader(new InputStreamReader(con.getInputStream()));
            String inputLine;
            while ((inputLine = in.readLine()) != null) {
                content.append(inputLine);
            }
            in.close();
            
            if(con.getResponseCode() != 200){
                throw new Exception("Error getting access token.");    
            }

            JSONObject responseObj = new JSONObject(content.toString());
            accessToken = responseObj.getString("accessToken");
            con.disconnect();

            // NEW: Call check-identify API before saveReferraInfo
            url = new URL("https://pru-api-nprd.prudential.com.vn/pruforce/lead-corporate/uat1/lead/check-identify"); 
            con = (HttpURLConnection) url.openConnection(); 
            con.setRequestProperty("Authorization", "Bearer " + accessToken);
            con.setRequestProperty("Content-Type", "application/json");
            con.setRequestProperty("accept", "application/json");
            con.setRequestProperty("Cookie", "JSESSIONID=uMEqdM4bbxEPW3WxBnUsEB58FLtR7Ux0BD7eBS5W; visid_incap_2439160=HnGgAHe5RZGFXE7Zhb8VknNnAmEAAAAAQUIPAAAAAACGoKq1pBfgHaFiGxrNWX1K; visid_incap_2520419=Hlqz69LhTPWpwOn973fkR3BYB2EAAAAAQUIPAAAAAADK0LSSnRzumfMjGJF7f2jr");
            con.setRequestMethod("POST"); 
            con.setDoOutput(true);
            con.setConnectTimeout(5000);
            con.setReadTimeout(5000);
            
            // Use hardcoded nationalId value as per your existing code logic
			String checkNationalId = "HCM"; // Using the same hardcoded value
            
            jsonObject = new JSONObject();
            jsonObject.put("identifyNo", checkNationalId);

            bout = jsonObject.toString().getBytes(StandardCharsets.UTF_8);
            length = bout.length;

            con.setFixedLengthStreamingMode(length);
            con.connect();
            
            os = con.getOutputStream();
            os.write(bout);

            content = new StringBuffer();           
            in = new BufferedReader(new InputStreamReader(con.getInputStream()));
            inputLine = "";
            while ((inputLine = in.readLine()) != null) {
                content.append(inputLine);
            }
            in.close();
            
            String checkIdentifyResponse = content.toString();
            con.disconnect();
            
            if(con.getResponseCode() != 200){
                // Handle error response
                try {
                    JSONObject errorObj = new JSONObject(checkIdentifyResponse);
                    String errorDesc = errorObj.getString("errorDescription");
                    out.print(responeObject(400, errorDesc));
                    return;
                } catch(Exception jsonEx) {
                    out.print(responeObject(400, "Error checking national ID"));
                    return;
                }
            } else {
                // Handle success response
                try {
                    JSONObject successObj = new JSONObject(checkIdentifyResponse);
                    boolean isExist = successObj.getBoolean("isExist");
                    if(!isExist) {
                        out.print(responeObject(400, "Please enter valid national id"));
                        return;
                    }
                    // If isExist is true, continue to saveReferraInfo API
                } catch(Exception jsonEx) {
                    out.print(responeObject(400, "Error processing check-identify response"));
                    return;
                }
            }

            //send payload to saveReferraInfo (only if check-identify passed)
            url = new URL("https://pru-api-nprd.prudential.com.vn/pruforce/lead-corporate/uat1/lead/saveReferraInfo"); 
            con = (HttpURLConnection) url.openConnection(); 
            con.setRequestProperty("Authorization", "Bearer " + accessToken);
            con.setRequestProperty("Content-Type", "application/json");
            con.setRequestProperty("Cookie", "JSESSIONID=uMEqdM4bbxEPW3WxBnUsEB58FLtR7Ux0BD7eBS5W; visid_incap_2439160=HnGgAHe5RZGFXE7Zhb8VknNnAmEAAAAAQUIPAAAAAACGoKq1pBfgHaFiGxrNWX1K; visid_incap_2520419=Hlqz69LhTPWpwOn973fkR3BYB2EAAAAAQUIPAAAAAADK0LSSnRzumfMjGJF7f2jr");
            con.setRequestMethod("POST"); 
            con.setDoOutput(true);
            //con.setConnectTimeout(2000);
            //con.setReadTimeout(2000);
            
            String policy_number_status = "true";
            if(StringUtils.isEmpty(policy_number)) {
                policy_number_status = "false";
            }
            
            Date dNow = new Date( );
            SimpleDateFormat ft = new SimpleDateFormat ("dd-MMM-yyyy HH:mm");
			
			firstName = firstName.replaceAll("&nbsp;", " ");
			lastName = lastName.replaceAll("&nbsp;", " ");
			country_code = country_code.replace("+", "");
			nationalId = "HCM";
			lastName = "600000012";
			provide_area = "76062238";
            
            jsonObject = new JSONObject();
            //jsonObject.put("category", "PULSELEADS_MB");
            jsonObject.put("fullName", firstName);
            //jsonObject.put("name", lastName);
            //jsonObject.put("gender", "gender");
            jsonObject.put("mobile", country_code+phone_no);
			jsonObject.put("nationalId", nationalId);
			jsonObject.put("referralAgent", lastName);
			jsonObject.put("policyNumber", provide_area);
            /*jsonObject.put("email", emailAddressUser);
            jsonObject.put("isCustomer", policy_number_status);
            jsonObject.put("componentCode", componentCode);
            jsonObject.put("messageCategory", maritalStatus);
            jsonObject.put("nationalId", nationalId);
            jsonObject.put("timeContact", ft.format(dNow));
            jsonObject.put("messageDetails", provide_area);
            jsonObject.put("check", true);
            jsonObject.put("j_captcha", "");
            jsonObject.put("utmCampaign", utmCampaign);
            jsonObject.put("utmMedium", utmMedium);
            jsonObject.put("utmSource", utmSource);
            jsonObject.put("gender", "gender");
            jsonObject.put("provinceCode", paramSelectTopics[1]);*/
			

            bout = jsonObject.toString().getBytes(StandardCharsets.UTF_8);
  			length = bout.length;

  			con.setFixedLengthStreamingMode(length);
  			con.connect();
			os = con.getOutputStream();
			os.write(bout);
	
            content = new StringBuffer();
	        
            in = new BufferedReader(new InputStreamReader(con.getInputStream()));
		    inputLine = "";
		    
            while ((inputLine = in.readLine()) != null) {
    		    content.append(inputLine);
		    }
            in.close();
            apiResponse =content.toString();
            con.disconnect();
           
		  
		   
            if (con.getResponseCode() != 200) {
              throw new Exception("Error calling API: " + apiResponse);
            } else {
              isApiCallSuccess = true;

              // Extract referralId from response for thank you page
              try {
        JSONObject saveReferraResponse = new JSONObject(apiResponse);
        String referralId = saveReferraResponse.getString("referralId");

        // ---- Store in Session (optional) ----
        session.setAttribute("referralId", referralId);
        session.setAttribute("referralAgent", lastName);

        // ---- Store in Cookie for HTML/JavaScript access ----
        Cookie referralCookie = new Cookie("referralId", referralId);
        referralCookie.setPath("/"); // make it accessible for the whole domain
        referralCookie.setMaxAge(60 * 60 * 24 * 7); // 1 week
        response.addCookie(referralCookie);

        Cookie agentCookie = new Cookie("referralAgent", lastName);
        agentCookie.setPath("/");
        agentCookie.setMaxAge(60 * 60 * 24 * 7); // 1 week
        response.addCookie(agentCookie);

    } catch (Exception jsonEx) {
        // Log error but don't fail the process
    }
}

   
        }catch(Exception ex){
		
			out.print(responeObject(400, ("API Error "+ex.toString()) ));
            isApiCallSuccess = false;
        }
  
        if(isSendEmail && isApiCallSuccess){
            out.print(responeObject(200, "send email and api call success."));    
        }else{
           // out.print(responeObject(200, "send email success."));
        }
                   
%>
