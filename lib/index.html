<%@ page session="false" contentType="text/html;charset=UTF-8" %>
<%@ page import="java.io.*, java.net.*, org.json.JSONObject,
org.opencms.main.OpenCms, org.apache.commons.logging.Log, org.opencms.main.CmsLog, 
org.apache.commons.lang.StringUtils, java.util.*, java.text.*" %>
<%@ page import="java.util.Locale" %>
<%@ page import="org.opencms.jsp.CmsJspActionElement"%>
<%@ taglib prefix="cms" uri="http://www.opencms.org/taglib/cms"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ page import="javax.xml.bind.DatatypeConverter"%>
<%@ page import="org.opencms.jsp.*, org.opencms.file.*, org.opencms.flex.*,org.opencms.util.*" %>

<c:set var="locale" value="${cms.locale}" />
<fmt:setLocale value="${param.language}" />

<%
// Initialize logging for debugging
Log LOG = CmsLog.getLog(this.getClass());

// Parse topic parameter
String paramSelectTopic = StringUtils.isEmpty(request.getParameter("selectTopic")) ? "" : request.getParameter("selectTopic");
String[] paramSelectTopics = paramSelectTopic.split("&&");
%>

<cms:bundle basename="com.prudential.v2.ph.default">
  <c:set var="paramSelectTopics"><%=paramSelectTopics.length > 0 ? paramSelectTopics[0] : ""%></c:set>
  <c:set var="emailEnquiry" value=""/>
  <c:if test="${not empty paramSelectTopics}">
    <c:set var="emailEnquiry"><fmt:message key="key.mail.selected.enquiry.${paramSelectTopics}" /></c:set>
  </c:if>
</cms:bundle>

<%!
    // Utility methods
    public String escapeHtml(String input) {
        if (input == null) return "";
        String result = input;
        result = result.replaceAll("&", "&amp;");
        result = result.replaceAll("<", "&lt;");
        result = result.replaceAll(">", "&gt;");
        result = result.replaceAll("\"", "&quot;");
        result = result.replaceAll("'", "&#39;");
        return result;
    }
    
    public String createJsonResponse(int statusCode, String message) {
        StringBuffer sb = new StringBuffer();
        sb.append("{");
        sb.append("\"statusCode\":").append(statusCode).append(",");
        sb.append("\"message\":\"").append(message != null ? message.replaceAll("\"", "\\\\\"") : "").append("\"");
        sb.append("}");
        return sb.toString();
    }
%>

<%
try {
    CmsJspActionElement cms = new CmsJspActionElement(pageContext, request, response);
    CmsObject cmsObject = cms.getCmsObject();
    Locale locale = cms.getRequestContext().getLocale(); 
    
    // Decode and read XML configuration file
    String pathFile = request.getParameter("file-path");
    if (StringUtils.isEmpty(pathFile)) {
        LOG.error("Missing file-path parameter");
        out.print(createJsonResponse(400, "Missing configuration file path"));
        return;
    }
    
    byte[] valueDecoded = DatatypeConverter.parseBase64Binary(pathFile);
    String pathFileXml = new String(valueDecoded, "UTF-8");
    
    CmsResource contentRs = cmsObject.readResource(pathFileXml);
    CmsJspContentAccessBean componentPros = new CmsJspContentAccessBean(cmsObject, locale, contentRs);
    
    // Get API configuration
    String sendToApiStr = "true"; // Always send to API now
    boolean isSendToApi = Boolean.valueOf(sendToApiStr).booleanValue();
    
    // Get topic information
    String topic = paramSelectTopics.length > 1 ? paramSelectTopics[1] : "";
    String topicKey = paramSelectTopics.length > 0 ? paramSelectTopics[0] : "";
    
    if (!isSendToApi) {
        out.print(createJsonResponse(200, "API call disabled"));
        return;
    }
    
    // Process form parameters
    Enumeration parameterNames = request.getParameterNames();
    String fullName = "";
    String phoneNo = "";
    String nationalId = "";
    String referralAgent = "";
    String policyID = "";
    
    while (parameterNames.hasMoreElements()) {
        String parameterName = (String) parameterNames.nextElement();
        String value = "";
        
        if ("selectTopic".equals(parameterName)) {
            value = topic;
        } else {
            String rawValue = request.getParameter(parameterName);
            value = rawValue != null ? escapeHtml(rawValue) : "";
        }
        
        // Extract specific fields for API call
        if ("full-name".equals(parameterName)) {
            fullName = value;
        } else if ("phone-no".equals(parameterName)) {
            phoneNo = value;
        } else if ("nationalID".equals(parameterName)) {
            nationalId = value;
        } else if ("referralCode".equals(parameterName)) {
            referralAgent = value;
        } else if ("policyID".equals(parameterName)) {
            policyID = value;
        }
    }
    
    // Validate required fields
    if (StringUtils.isEmpty(fullName) || StringUtils.isEmpty(phoneNo)) {
        LOG.warn("Missing required fields: fullName=" + fullName + ", phoneNo=" + phoneNo);
        out.print(createJsonResponse(400, "Missing required fields"));
        return;
    }
    
    // API Integration
    boolean isApiCallSuccess = true;
    String responseMessage = "";
    String accessToken = "";
    String authRequestBody = "";
    String authResponseBody = "";
    String leadRequestBody = "";
    String leadResponseBody = "";
    String debugInfo = "";
    
    try {
        LOG.info("Starting API authentication");
        
        // Get access token
        URL url = new URL("https://vn-lead-corporate-uat.aks-lb1-vnlife-uat-az2-orch2h.pru.intranet.asia/auth/login");
        HttpURLConnection con = (HttpURLConnection) url.openConnection();
        con.setRequestProperty("Content-Type", "application/json");
        con.setRequestProperty("Accept", "application/json");
        con.setRequestMethod("POST");
        con.setDoOutput(true);
        con.setConnectTimeout(15000);
        con.setReadTimeout(15000);
        
        // Create login request JSON
        JSONObject loginRequest = new JSONObject();
        loginRequest.put("password", "Prudential01@");
        loginRequest.put("username", "pulseleaduat");
        authRequestBody = loginRequest.toString();
        
        debugInfo += "AUTH API URL: " + url.toString() + "\\n";
        debugInfo += "AUTH REQUEST BODY: " + authRequestBody + "\\n";
        
        // Write request - Java 6 compatible
        OutputStream os = con.getOutputStream();
        OutputStreamWriter writer = new OutputStreamWriter(os, "UTF-8");
        writer.write(authRequestBody);
        writer.flush();
        writer.close();
        os.close();
        
        // Read authentication response
        int responseCode = con.getResponseCode();
        debugInfo += "AUTH RESPONSE CODE: " + responseCode + "\\n";
        LOG.info("Authentication response code: " + responseCode);
        
        if (responseCode != 200) {
            // Try to read error response
            InputStream errorStream = con.getErrorStream();
            if (errorStream != null) {
                BufferedReader errorReader = new BufferedReader(new InputStreamReader(errorStream, "UTF-8"));
                StringBuffer errorContent = new StringBuffer();
                String errorLine;
                while ((errorLine = errorReader.readLine()) != null) {
                    errorContent.append(errorLine);
                }
                errorReader.close();
                authResponseBody = errorContent.toString();
                debugInfo += "AUTH ERROR RESPONSE: " + authResponseBody + "\\n";
                LOG.error("Authentication error response: " + authResponseBody);
            }
            throw new Exception("Authentication failed. Response code: " + responseCode);
        }
        
        BufferedReader in = new BufferedReader(new InputStreamReader(con.getInputStream(), "UTF-8"));
        StringBuffer content = new StringBuffer();
        String inputLine;
        while ((inputLine = in.readLine()) != null) {
            content.append(inputLine);
        }
        in.close();
        con.disconnect();
        
        authResponseBody = content.toString();
        debugInfo += "AUTH SUCCESS RESPONSE: " + authResponseBody + "\\n";
        
        JSONObject responseObj = new JSONObject(authResponseBody);
        accessToken = responseObj.getString("accessToken");
        LOG.info("Authentication successful, token obtained");
        
        // Send lead data
        LOG.info("Sending lead data to API");
        url = new URL("https://intranet.asia/lead/saveReferraInfo");
        con = (HttpURLConnection) url.openConnection();
        con.setRequestProperty("Authorization", "Bearer " + accessToken);
        con.setRequestProperty("Content-Type", "application/json");
        con.setRequestProperty("Accept", "application/json");
        con.setRequestMethod("POST");
        con.setDoOutput(true);
        con.setConnectTimeout(15000);
        con.setReadTimeout(15000);
        
        // Create lead data JSON
        JSONObject leadData = new JSONObject();
        leadData.put("fullName", fullName);
        leadData.put("mobile", phoneNo);
        leadData.put("nationalId", nationalId);
        leadData.put("referralAgent", referralAgent);
        leadData.put("policyNumber", policyID);
        leadRequestBody = leadData.toString();
        
        debugInfo += "LEAD API URL: " + url.toString() + "\\n";
        debugInfo += "LEAD REQUEST BODY: " + leadRequestBody + "\\n";
        debugInfo += "AUTHORIZATION HEADER: Bearer " + accessToken.substring(0, Math.min(20, accessToken.length())) + "...\\n";
        
        LOG.info("Lead data JSON: " + leadRequestBody);
        
        // Write lead data - Java 6 compatible  
        os = con.getOutputStream();
        writer = new OutputStreamWriter(os, "UTF-8");
        writer.write(leadRequestBody);
        writer.flush();
        writer.close();
        os.close();
        
        // Read lead submission response
        responseCode = con.getResponseCode();
        debugInfo += "LEAD RESPONSE CODE: " + responseCode + "\\n";
        LOG.info("Lead submission response code: " + responseCode);
        
        if (responseCode != 200) {
            // Try to read error response
            InputStream errorStream = con.getErrorStream();
            if (errorStream != null) {
                BufferedReader errorReader = new BufferedReader(new InputStreamReader(errorStream, "UTF-8"));
                StringBuffer errorContent = new StringBuffer();
                String errorLine;
                while ((errorLine = errorReader.readLine()) != null) {
                    errorContent.append(errorLine);
                }
                errorReader.close();
                leadResponseBody = errorContent.toString();
                debugInfo += "LEAD ERROR RESPONSE: " + leadResponseBody + "\\n";
                LOG.error("Lead submission error response: " + leadResponseBody);
                throw new Exception("Lead submission failed: " + leadResponseBody + " (Code: " + responseCode + ")");
            } else {
                debugInfo += "LEAD ERROR: No error response body available\\n";
                throw new Exception("Lead submission failed with response code: " + responseCode);
            }
        }
        
        in = new BufferedReader(new InputStreamReader(con.getInputStream(), "UTF-8"));
        content = new StringBuffer();
        while ((inputLine = in.readLine()) != null) {
            content.append(inputLine);
        }
        in.close();
        con.disconnect();
        
        leadResponseBody = content.toString();
        debugInfo += "LEAD SUCCESS RESPONSE: " + leadResponseBody + "\\n";
        LOG.info("Lead submission successful: " + leadResponseBody);
        
    } catch (Exception ex) {
        LOG.error("API call failed: " + ex.getMessage(), ex);
        responseMessage = ex.getMessage();
        debugInfo += "EXCEPTION: " + ex.getMessage() + "\\n";
        isApiCallSuccess = false;
    }
    
    // Return response with detailed debug information
    if (isApiCallSuccess) {
        String successMessage = "API call successful. DEBUG INFO: " + debugInfo;
        out.print(createJsonResponse(200, successMessage));
    } else {
        String errorMessage = "API call failed: " + responseMessage + ". DEBUG INFO: " + debugInfo;
        out.print(createJsonResponse(500, errorMessage));
    }
    
} catch (Exception e) {
    LOG.error("Fatal error in contact form processing", e);
    out.print(createJsonResponse(500, "Internal server error: " + e.getMessage()));
}
%>
