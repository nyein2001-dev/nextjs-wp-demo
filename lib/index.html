for (FileItem item : items) {
    if (!item.isFormField()) {
        String fieldName = item.getFieldName();
        System.out.println("Found file field: " + fieldName + " file: " + item.getName());

        if (!fieldFilesMap.containsKey(fieldName)) {
            fieldFilesMap.put(fieldName, new ArrayList<FileItem>());
        }
        fieldFilesMap.get(fieldName).add(item);
    }
}
System.out.println("Total fields with files: " + fieldFilesMap.size());


                public static void sendEmail(String from, String to, String subject, String message, Map<String, List<FileItem>> fieldFilesMap) throws Exception {
    System.out.println("Sending email from: " + from + " to: " + to);
    CmsHtmlMail email = new CmsHtmlMail();
    email.setFrom(from);
    email.addTo(to);
    email.setSubject(subject);
    email.setMsg(message);
    email.setCharset("UTF-8");

    if (fieldFilesMap == null || fieldFilesMap.isEmpty()) {
        System.out.println("No files found to attach.");
    }

    Iterator<Map.Entry<String, List<FileItem>>> iterator = fieldFilesMap.entrySet().iterator();
    while (iterator.hasNext()) {
        Map.Entry<String, List<FileItem>> entry = iterator.next();
        String fieldName = entry.getKey();
        List<FileItem> fileItems = entry.getValue();

        System.out.println("Processing field: " + fieldName + ", files: " + fileItems.size());

        for (int i = 0; i < fileItems.size(); i++) {
            FileItem fileItem = (FileItem) fileItems.get(i);
            String originalFileName = fileItem.getName();
            if (originalFileName == null || originalFileName.trim().isEmpty()) {
                System.out.println("FileItem " + i + " has no name, skipping.");
                continue;
            }

            System.out.println("Original file name: " + originalFileName);

            String extension = "";
            int dotIndex = originalFileName.lastIndexOf('.');
            if (dotIndex > 0) {
                extension = originalFileName.substring(dotIndex);
            }

            String renamedFile = fieldName + "_" + i + extension;
            File tempFile = createTempFileFromInputStream(fileItem.getInputStream(), fieldName + "_" + i, extension);
            System.out.println("Temp file created: " + tempFile.getAbsolutePath());

            if (!tempFile.exists()) {
                System.out.println("Temp file not found: " + tempFile.getAbsolutePath());
                continue;
            }

            EmailAttachment attachment = new EmailAttachment();
            attachment.setPath(tempFile.getAbsolutePath());
            attachment.setName(renamedFile);
            attachment.setDisposition(EmailAttachment.ATTACHMENT);
            email.attach(attachment);
            System.out.println("Attached file: " + renamedFile);

            tempFile.deleteOnExit();
        }
    }

    System.out.println("Sending email...");
    email.send();
    System.out.println("Email sent successfully.");
}
