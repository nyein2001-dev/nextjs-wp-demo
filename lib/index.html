<%@ page session="false" contentType="text/html;charset=UTF-8" %>
<%@ page import="java.io.*, java.net.*, javax.net.*, org.json.JSONObject,
org.opencms.main.OpenCms, org.apache.commons.logging.Log, org.opencms.main.CmsLog, 
org.apache.commons.lang.StringUtils, java.util.*, java.text.*, java.nio.charset.*" %>
<%@ page import="java.util.Locale" %>
<%@ page import="org.opencms.jsp.CmsJspActionElement"%>
<%@ taglib prefix="cms" uri="http://www.opencms.org/taglib/cms"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ page import="javax.xml.bind.DatatypeConverter"%>
<%@ page import="org.opencms.jsp.*, org.opencms.file.*, org.opencms.flex.*,org.opencms.util.*" %>
<%@ page import="javax.net.ssl.*, java.security.cert.*" %>

<c:set var="locale" value="${cms.locale}" />
<fmt:setLocale value="${param.language}" />

<%
// Initialize logging for debugging
Log LOG = CmsLog.getLog(this.getClass());

// Parse topic parameter
String paramSelectTopic = StringUtils.isEmpty(request.getParameter("selectTopic")) ? "" : request.getParameter("selectTopic");
String[] paramSelectTopics = paramSelectTopic.split("&&");
%>

<cms:bundle basename="com.prudential.v2.ph.default">
  <c:set var="paramSelectTopics"><%=paramSelectTopics.length > 0 ? paramSelectTopics[0] : ""%></c:set>
  <c:set var="emailEnquiry" value=""/>
  <c:if test="${not empty paramSelectTopics}">
    <c:set var="emailEnquiry"><fmt:message key="key.mail.selected.enquiry.${paramSelectTopics}" /></c:set>
  </c:if>
</cms:bundle>

<%!
    // Utility methods
    public String A1filter(String input) {
        if (input == null) return "";
        String tem = input;
        tem = tem.replaceAll("<", "&lt;");
        tem = tem.replaceAll(">", "&gt;");
        tem = tem.replaceAll("&", "&amp;");
        tem = tem.replaceAll("\"", "&quot;");
        tem = tem.replaceAll(" ", "&nbsp;");
        tem = tem.replaceAll("'", "&#39;");
        return tem;
    }
    
    public String responeObject(int statusCode, String message) {
        StringBuffer sb = new StringBuffer();
        sb.append("{");
        sb.append("\"statusCode\":").append(statusCode).append(",");
        sb.append("\"message\":\"").append(message != null ? message.replaceAll("\"", "\\\\\"") : "").append("\"");
        sb.append("}");
        return sb.toString();
    }
    
    // SSL Trust Manager to bypass certificate validation (for UAT environment)
    public static class TrustAllManager implements X509TrustManager {
        public X509Certificate[] getAcceptedIssuers() { return null; }
        public void checkClientTrusted(X509Certificate[] certs, String authType) { }
        public void checkServerTrusted(X509Certificate[] certs, String authType) { }
    }
    
    // Hostname verifier to accept all hostnames
    public static class TrustAllHostnameVerifier implements HostnameVerifier {
        public boolean verify(String hostname, SSLSession session) { return true; }
    }
    
    // Method to disable SSL verification
    public void disableSSLVerification() throws Exception {
        TrustManager[] trustAllCerts = new TrustManager[] { new TrustAllManager() };
        SSLContext sc = SSLContext.getInstance("SSL");
        sc.init(null, trustAllCerts, new java.security.SecureRandom());
        HttpsURLConnection.setDefaultSSLSocketFactory(sc.getSocketFactory());
        HttpsURLConnection.setDefaultHostnameVerifier(new TrustAllHostnameVerifier());
    }
%>

<%
try {
    CmsJspActionElement cms = new CmsJspActionElement(pageContext, request, response);
    CmsObject cmsObject = cms.getCmsObject();
    Locale locale = cms.getRequestContext().getLocale(); 
    
    // Decode and read XML configuration file
    String pathFile = request.getParameter("file-path");
    if (StringUtils.isEmpty(pathFile)) {
        LOG.error("Missing file-path parameter");
        out.print(responeObject(400, "Missing configuration file path"));
        return;
    }
    
    byte[] valueDecoded = DatatypeConverter.parseBase64Binary(pathFile);
    String pathFileXml = new String(valueDecoded, "UTF-8");
    
    CmsResource contentRs = cmsObject.readResource(pathFileXml);
    CmsJspContentAccessBean componentPros = new CmsJspContentAccessBean(cmsObject, locale, contentRs);
    
    // Get email configuration - following original code structure
    String SendEmail = componentPros.getValue().get("EmailAndDB").getValue().get("SendEmail").getStringValue();
    Boolean isSendEmail = Boolean.valueOf(SendEmail);
    
    // Get topic information - following original code structure
    String topic = StringUtils.isEmpty(paramSelectTopic) ? "" : paramSelectTopics[1];
    String topickey = StringUtils.isEmpty(paramSelectTopic) ? "" : paramSelectTopics[0];
    
    if (!isSendEmail) {
        out.print(responeObject(200, "send mail success"));
        return;
    }
    
    // Process form parameters - following original code structure
    Enumeration enumeration = request.getParameterNames();
    String fullName = "";
    String phone_no = "";
    String nationalId = "";
    String referralAgent = "";
    String policyID = "";
    String accessToken = "";
    boolean isApiCallSuccess = true;
    String apiResponse = "";
    String apiResponse2 = "";
    String debugInfo = "";
    
    try {
        while (enumeration.hasMoreElements()) {
            String parameterName = enumeration.nextElement().toString();
            String value = "";
            if (parameterName.equals("selectTopic")) {
                value = topic;
            } else {
                value = A1filter(request.getParameter(parameterName));
            }
            
            // Extract specific fields for API call - following original code
            if ("full-name".equals(parameterName)) {
                fullName = value;
            }
            if ("phone-no".equals(parameterName)) {
                phone_no = value;
            }
            if ("nationalID".equals(parameterName)) {
                nationalId = value;
            }
            if ("referralCode".equals(parameterName)) {
                referralAgent = value;
            }
            if ("policyID".equals(parameterName)) {
                policyID = value;
            }
        }
        
        String responseMessage = "";
        
        try {
            // Disable SSL verification for UAT environment
            disableSSLVerification();
            
            debugInfo += "SSL verification disabled for UAT environment\\n";
            
            // Get access token - following original code structure
            URL url = new URL("https://vn-lead-corporate-uat.aks-lb1-vnlife-uat-az2-orch2h.pru.intranet.asia/auth/login");
            HttpURLConnection con = (HttpURLConnection) url.openConnection();
            con.setRequestProperty("Content-Type", "application/json");
            con.setRequestProperty("accept", "application/json");
            con.setRequestMethod("POST");
            con.setDoOutput(true);
            // Following original - no timeout set initially
            
            JSONObject jsonObject = new JSONObject();
            jsonObject.put("password", "Prudential01@");
            jsonObject.put("username", "pulseleaduat");
            
            debugInfo += "AUTH API URL: " + url.toString() + "\\n";
            debugInfo += "AUTH REQUEST BODY: " + jsonObject.toString() + "\\n";
            
            // Following original code pattern
            byte[] bout = jsonObject.toString().getBytes("UTF-8");
            int length = bout.length;
            
            con.setFixedLengthStreamingMode(length);
            con.connect();
            
            OutputStream os = con.getOutputStream();
            os.write(bout);
            
            StringBuffer content = new StringBuffer();
            BufferedReader in = new BufferedReader(new InputStreamReader(con.getInputStream()));
            String inputLine;
            while ((inputLine = in.readLine()) != null) {
                content.append(inputLine);
            }
            in.close();
            
            debugInfo += "AUTH RESPONSE CODE: " + con.getResponseCode() + "\\n";
            debugInfo += "AUTH RESPONSE BODY: " + content.toString() + "\\n";
            
            if (con.getResponseCode() != 200) {
                throw new Exception("Error getting access token.");
            }
            
            JSONObject responseObj = new JSONObject(content.toString());
            accessToken = responseObj.getString("accessToken");
            con.disconnect();
            
            // Send payload - following original code structure
            url = new URL("https://intranet.asia/lead/saveReferraInfo");
            con = (HttpURLConnection) url.openConnection();
            con.setRequestProperty("Authorization", "Bearer " + accessToken);
            con.setRequestProperty("Content-Type", "application/json");
            con.setRequestMethod("POST");
            con.setDoOutput(true);
            
            Date dNow = new Date();
            SimpleDateFormat ft = new SimpleDateFormat("dd-MMM-yyyy HH:mm");
            
            jsonObject = new JSONObject();
            jsonObject.put("fullName", fullName);
            jsonObject.put("mobile", phone_no);
            jsonObject.put("nationalId", nationalId);
            jsonObject.put("referralAgent", referralAgent);
            jsonObject.put("policyNumber", policyID);
            
            debugInfo += "LEAD API URL: " + url.toString() + "\\n";
            debugInfo += "LEAD REQUEST BODY: " + jsonObject.toString() + "\\n";
            debugInfo += "AUTHORIZATION HEADER: Bearer " + accessToken.substring(0, Math.min(20, accessToken.length())) + "...\\n";
            
            bout = jsonObject.toString().getBytes("UTF-8");
            length = bout.length;
            
            con.setFixedLengthStreamingMode(length);
            con.connect();
            os = con.getOutputStream();
            os.write(bout);
            
            content = new StringBuffer();
            
            in = new BufferedReader(new InputStreamReader(con.getInputStream()));
            inputLine = "";
            
            while ((inputLine = in.readLine()) != null) {
                content.append(inputLine);
            }
            in.close();
            apiResponse = content.toString();
            apiResponse2 = con.getResponseMessage();
            con.disconnect();
            
            debugInfo += "LEAD RESPONSE CODE: " + con.getResponseCode() + "\\n";
            debugInfo += "LEAD RESPONSE BODY: " + apiResponse + "\\n";
            debugInfo += "LEAD RESPONSE MESSAGE: " + apiResponse2 + "\\n";
            
            if (con.getResponseCode() != 200) {
                throw new Exception("Error calling API: " + apiResponse);
            } else {
                isApiCallSuccess = true;
            }
            
        } catch (Exception ex) {
            debugInfo += "EXCEPTION: " + ex.toString() + "\\n";
            responseMessage = ex.toString();
            isApiCallSuccess = false;
        }
        
        // Following original code response pattern
        if (isApiCallSuccess) {
            out.print(responeObject(200, "send email and api call success. DEBUG INFO: " + debugInfo));
        } else {
            out.print(responeObject(200, "send email success, error=" + responseMessage + ". DEBUG INFO: " + debugInfo));
        }
        
    } catch (Exception mainEx) {
        LOG.error("Error in main processing", mainEx);
        out.print(responeObject(400, "Main processing error: " + mainEx.toString()));
    }
    
} catch (Exception e) {
    LOG.error("Fatal error in contact form processing", e);
    out.print(responeObject(500, "Internal server error: " + e.getMessage()));
}
%>
