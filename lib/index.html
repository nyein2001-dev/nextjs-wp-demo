Map<String, List<FileItem>> fieldFilesMap = new HashMap<>();

for (FileItem item : items) {
    if (!item.isFormField()) {
        String fieldName = item.getFieldName();

        if (!fieldFilesMap.containsKey(fieldName)) {
            fieldFilesMap.put(fieldName, new ArrayList<FileItem>());
        }
        fieldFilesMap.get(fieldName).add(item);
    }
}

import org.apache.commons.fileupload.FileItem;
import org.apache.commons.mail.EmailAttachment;
import org.opencms.mail.CmsHtmlMail;
import org.apache.commons.io.FilenameUtils;

...

// Create the email
CmsHtmlMail smToCs = new CmsHtmlMail();
smToCs.setMsg(mailContentUser);
smToCs.setSubject(mailSubject + " " + policyNumber);
smToCs.setCharset("UTF-8");
smToCs.setFrom("withdrawals@prulifeuk.com.ph");
smToCs.addTo(emailAddressUser);

// Store temp files to delete later
List<File> tempFilesToDelete = new ArrayList<File>();

// Process file uploads
for (Map.Entry<String, List<FileItem>> entry : fieldFilesMap.entrySet()) {
    String fieldName = entry.getKey();
    List<FileItem> fileItems = entry.getValue();

    for (int i = 0; i < fileItems.size(); i++) {
        FileItem fileItem = fileItems.get(i);
        String originalFileName = fileItem.getName();
        if (originalFileName == null || originalFileName.isEmpty()) {
            continue;
        }

        String extension = "";
        int dotIndex = originalFileName.lastIndexOf('.');
        if (dotIndex > 0) {
            extension = originalFileName.substring(dotIndex);
        }

        // Rename with index if multiple
        String newFileName = fieldName + "_" + i + extension;

        // Create temp file
        File tempFile = createTempFileFromInputStream(fileItem.getInputStream(), fieldName + "_" + i, extension);
        tempFilesToDelete.add(tempFile);

        EmailAttachment attachment = new EmailAttachment();
        attachment.setPath(tempFile.getAbsolutePath());
        attachment.setDisposition(EmailAttachment.ATTACHMENT);
        attachment.setName(newFileName); // This sets the attachment name

        smToCs.attach(attachment);
    }
}

// Send email
smToCs.send();

// Clean up temp files
for (File file : tempFilesToDelete) {
    file.deleteOnExit();
}
