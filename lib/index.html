// Assume this is a complete list of file inputs from request
List<FileItem> uploadedFileItems = ...; // from FileUpload parser

// Send to user
if (!StringUtils.isEmpty(emailAddressUser)) {
    sendEmailWithAttachments(
        emailAddressAdmins.get(0),
        emailAddressUser,
        mailSubject,
        mailContentUser,
        uploadedFileItems
    );
}

// Send to each admin
for (String emailAdmin : emailAddressAdmins) {
    sendEmailWithAttachments(
        emailAddressUser,
        emailAdmin,
        adminMailSubject,
        mailContent,
        uploadedFileItems
    );
}



    public void sendEmailWithAttachments(
        String from,
        String to,
        String subject,
        String message,
        List<FileItem> uploadedFileItems
) throws Exception {

    CmsHtmlMail email = new CmsHtmlMail();
    email.setMsg(message);
    email.setSubject(subject);
    email.setCharset("UTF-8");
    email.setFrom(from);
    email.addTo(to);

    List<File> tempFilesToDelete = new ArrayList<File>();

    // Group by field name and allow multiple files per field
    Map<String, List<FileItem>> fieldMap = new HashMap<String, List<FileItem>>();
    for (FileItem fileItem : uploadedFileItems) {
        if (!fileItem.isFormField()) {
            String fieldName = fileItem.getFieldName();
            if (!fieldMap.containsKey(fieldName)) {
                fieldMap.put(fieldName, new ArrayList<FileItem>());
            }
            fieldMap.get(fieldName).add(fileItem);
        }
    }

    // Process and attach
    for (Map.Entry<String, List<FileItem>> entry : fieldMap.entrySet()) {
        String fieldName = entry.getKey();
        List<FileItem> fileItems = entry.getValue();

        for (int i = 0; i < fileItems.size(); i++) {
            FileItem fileItem = fileItems.get(i);
            String originalFileName = fileItem.getName();
            String extension = "";
            int dotIndex = originalFileName.lastIndexOf('.');
            if (dotIndex > 0) {
                extension = originalFileName.substring(dotIndex);
            }

            String newFileName = fieldName + "_" + i + extension;
            File tempFile = createTempFileFromInputStream(fileItem.getInputStream(), fieldName + "_" + i, extension);
            tempFilesToDelete.add(tempFile);

            EmailAttachment attachment = new EmailAttachment();
            attachment.setPath(tempFile.getAbsolutePath());
            attachment.setDisposition(EmailAttachment.ATTACHMENT);
            attachment.setName(newFileName);

            email.attach(attachment);
        }
    }

    email.send();

    // Cleanup
    for (File tempFile : tempFilesToDelete) {
        tempFile.deleteOnExit();
    }
}



            public File createTempFileFromInputStream(InputStream inputStream, String baseName, String extension) throws IOException {
    File tempFile = File.createTempFile(baseName, extension);
    FileOutputStream out = new FileOutputStream(tempFile);
    byte[] buffer = new byte[1024];
    int bytesRead;
    while ((bytesRead = inputStream.read(buffer)) != -1) {
        out.write(buffer, 0, bytesRead);
    }
    out.close();
    inputStream.close();
    return tempFile;
}
